<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ASM Gest√£o Cl√≠nica</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f0f2f5}
.login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(135deg,#1e3a5f 0%,#2c5282 100%)}
.login-box{background:white;padding:40px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.2);width:90%;max-width:400px;text-align:center}
.login-box h1{color:#1e3a5f;margin-bottom:10px;font-size:28px}
.login-box h2{color:#666;font-size:18px;margin-bottom:30px;font-weight:normal}
.login-box .form-group{margin-bottom:20px;text-align:left}
.login-box input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px}
.login-btn{width:100%;padding:14px;background:#1e3a5f;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;font-weight:bold}
.login-btn:hover{background:#2c5282}
.login-error{color:#e53e3e;margin-top:15px;display:none;font-size:14px}
.header{background:#1e3a5f;color:white;padding:15px;text-align:center}
.header h1{margin:0;font-size:24px}
.header p{margin:5px 0 0 0;font-size:14px;opacity:0.9}
.user-bar{background:#152a45;color:white;padding:10px 20px;display:flex;justify-content:space-between;align-items:center}
.user-bar button{background:rgba(255,255,255,0.2);border:none;color:white;padding:5px 15px;border-radius:5px;cursor:pointer}
.user-bar button:hover{background:rgba(255,255,255,0.3)}
.nav{display:flex;justify-content:center;gap:10px;padding:10px;background:#2c5282;flex-wrap:wrap}
.nav button{padding:10px 20px;border:none;background:rgba(255,255,255,0.2);color:white;border-radius:5px;cursor:pointer;font-size:14px}
.nav button:hover,.nav button.active{background:white;color:#1e3a5f}
.container{max-width:1200px;margin:20px auto;padding:0 20px}
.section{display:none;background:white;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.section.active{display:block}
.btn{padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-size:14px;margin:5px;font-weight:bold}
.btn-primary{background:#1e3a5f;color:white}
.btn-primary:hover{background:#2c5282}
.btn-success{background:#38a169;color:white}
.btn-success:hover{background:#2f855a}
.btn-danger{background:#e53e3e;color:white}
.btn-danger:hover{background:#c53030}
.btn-whatsapp{background:#25d366;color:white}
.btn-whatsapp:hover{background:#128c7e}
.btn-warning{background:#d69e2e;color:white}
.btn-warning:hover{background:#b7791f}
.btn-pdf{background:#e53e3e;color:white}
.btn-pdf:hover{background:#c53030}
.btn-admin{background:#805ad5;color:white}
.btn-admin:hover{background:#6b46c1}
.form-group{margin-bottom:15px}
.form-group label{display:block;margin-bottom:5px;font-weight:bold;color:#2d3748}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid #cbd5e0;border-radius:5px;font-size:14px}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#1e3a5f}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:20px}
.card{background:white;padding:15px;border-radius:8px;border:2px solid #e2e8f0;cursor:pointer;transition:all 0.3s}
.card:hover{border-color:#1e3a5f;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-top:20px}
.calendar-header{text-align:center;font-weight:bold;padding:10px;background:#1e3a5f;color:white;border-radius:5px}
.calendar-day{background:#f7fafc;min-height:100px;padding:10px;border-radius:5px;cursor:pointer;border:1px solid #e2e8f0}
.appointment{background:#1e3a5f;color:white;padding:5px;margin:2px 0;border-radius:3px;font-size:12px;display:flex;justify-content:space-between;align-items:center}
.appointment.cancelled{background:#a0aec0;text-decoration:line-through;opacity:0.7}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:white;padding:30px;border-radius:10px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #e2e8f0;padding-bottom:10px}
.close-btn{background:none;border:none;font-size:28px;cursor:pointer;color:#718096}
.close-btn:hover{color:#1e3a5f}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{padding:12px;text-align:left;border-bottom:1px solid #e2e8f0}
th{background:#f7fafc;font-weight:bold;color:#2d3748}
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:20px}
.summary-card{padding:20px;border-radius:10px;text-align:center;color:white;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
.summary-card.green{background:#38a169}
.summary-card.red{background:#e53e3e}
.summary-card.blue{background:#1e3a5f}
.summary-card.purple{background:#805ad5}
.tabs{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #e2e8f0;flex-wrap:wrap}
.tab{padding:10px 20px;background:none;border:none;cursor:pointer;color:#4a5568;font-weight:bold}
.tab.active{color:#1e3a5f;border-bottom:2px solid #1e3a5f}
.tab-content{display:none}
.tab-content.active{display:block}
.settings-box{background:#ebf8ff;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #1e3a5f}
.footer{text-align:center;padding:20px;background:#1e3a5f;color:white;margin-top:40px;font-size:12px}
.session-checkbox{margin-right:10px;transform:scale(1.2)}
.session-row{cursor:pointer;transition:background 0.2s}
.session-row:hover{background:#ebf8ff}
.session-row.selected{background:#bee3f8}
.report-box{background:#f7fafc;padding:20px;border-radius:8px;white-space:pre-wrap;font-family:monospace;margin:20px 0;max-height:400px;overflow-y:auto;border:1px solid #e2e8f0;font-size:13px}
.financial-row{cursor:pointer;transition:background 0.2s}
.financial-row:hover{background:#ebf8ff}
.financial-row.selected{background:#bee3f8}
.activation-container{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#1e3a5f 0%,#2c5282 100%)}
.activation-box{background:white;padding:40px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.2);width:90%;max-width:450px;text-align:center}
.activation-box h2{color:#1e3a5f;margin-bottom:15px;font-size:24px}
.activation-box p{color:#4a5568;margin-bottom:25px;font-size:14px}
.code-input{width:100%;padding:15px;font-size:20px;text-align:center;letter-spacing:3px;border:2px solid #cbd5e0;border-radius:8px;margin-bottom:15px;text-transform:uppercase;font-weight:bold}
.code-input:focus{outline:none;border-color:#1e3a5f}
.cpf-input{width:100%;padding:15px;font-size:18px;text-align:center;border:2px solid #cbd5e0;border-radius:8px;margin-bottom:20px;font-weight:bold}
.cpf-input:focus{outline:none;border-color:#1e3a5f}
.activation-error{color:#e53e3e;margin-top:10px;display:none;font-size:14px;padding:10px;background:#fed7d7;border-radius:5px}
.activation-success{color:#38a169;margin-top:10px;display:none;font-size:14px;padding:10px;background:#c6f6d5;border-radius:5px}
.loading{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #1e3a5f;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.info-box{background:#ebf8ff;padding:15px;border-radius:8px;margin-bottom:20px;text-align:left;font-size:13px;color:#2c5282;border-left:4px solid #1e3a5f}
.info-box strong{color:#1e3a5f}
.patient-tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;justify-content:center}
.patient-tab-btn{padding:15px 20px;border:2px solid #e2e8f0;background:white;border-radius:10px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.3s;display:flex;flex-direction:column;align-items:center;gap:5px;min-width:120px}
.patient-tab-btn:hover{border-color:#1e3a5f;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.patient-tab-btn.active{background:#1e3a5f;color:white;border-color:#1e3a5f}
.patient-tab-btn .emoji{font-size:24px}
.patient-tab-btn .label{font-size:12px}
.chart-container{position:relative;height:300px;margin:20px 0}
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-top:20px}
.dashboard-card{background:white;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.dashboard-card h3{color:#1e3a5f;margin-bottom:15px;font-size:18px;border-bottom:2px solid #e2e8f0;padding-bottom:10px}
.admin-panel{background:#f7fafc;padding:20px;border-radius:10px;margin-top:20px}
.admin-table{width:100%;margin-top:15px}
.admin-table th{background:#1e3a5f;color:white}
.admin-table tr:nth-child(even){background:#f0f2f5}
.login-type-selector{display:flex;gap:10px;margin-bottom:20px;justify-content:center}
.login-type-btn{padding:10px 20px;border:2px solid #1e3a5f;background:white;color:#1e3a5f;border-radius:8px;cursor:pointer;font-weight:bold;transition:all 0.3s}
.login-type-btn.active{background:#1e3a5f;color:white}
.login-type-btn:hover{background:#2c5282;color:white}
.professional-selector{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:20px 0}
.professional-card{background:#f7fafc;padding:20px;border-radius:10px;border:2px solid #e2e8f0;cursor:pointer;transition:all 0.3s;text-align:center}
.professional-card:hover{border-color:#1e3a5f;transform:translateY(-2px)}
.professional-card.selected{background:#1e3a5f;color:white;border-color:#1e3a5f}
.professional-card .icon{font-size:40px;margin-bottom:10px}
.professional-card .name{font-weight:bold;font-size:16px}
.professional-card .specialty{font-size:12px;opacity:0.8}
.payment-method{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.payment-method label{display:flex;align-items:center;gap:5px;padding:8px 15px;background:#f7fafc;border-radius:5px;cursor:pointer;transition:all 0.2s}
.payment-method label:hover{background:#e2e8f0}
.payment-method input[type="radio"]{margin-right:5px}
.recurrence-options{background:#f7fafc;padding:15px;border-radius:8px;margin-top:15px}
.consultation-type-item{display:flex;gap:10px;align-items:center;margin-bottom:10px;padding:10px;background:#f7fafc;border-radius:5px}
.consultation-type-item input{flex:1}
.consultation-type-item button{background:#e53e3e;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer}
</style>
</head>
<body>

<!-- TELA DE LOGIN/ATIVA√á√ÉO -->
<div id="loginScreen" class="activation-container">
  <div class="activation-box">
    <h2>üîê ASM Gest√£o Cl√≠nica</h2>
    <p>Selecione o tipo de acesso</p>
    
    <div class="login-type-selector">
      <button class="login-type-btn active" onclick="showLoginType('user')" id="btnUserLogin">üë§ Profissional</button>
      <button class="login-type-btn" onclick="showLoginType('admin')" id="btnAdminLogin">üîí Administrador</button>
    </div>

    <!-- LOGIN USU√ÅRIO (CPF + C√≥digo) -->
    <div id="userLoginForm">
      <div class="info-box">
        <strong>Como funciona:</strong><br>
        ‚Ä¢ Digite seu CPF (somente n√∫meros)<br>
        ‚Ä¢ Digite o c√≥digo de ativa√ß√£o fornecido<br>
        ‚Ä¢ Formato: AA + 6 n√∫meros (ex: AA123456)
      </div>
      <div class="form-group" style="text-align:left">
        <label style="font-weight:bold;color:#2d3748;margin-bottom:5px;display:block">CPF</label>
        <input type="text" class="cpf-input" id="userCPF" placeholder="000.000.000-00" maxlength="14">
      </div>
      <div class="form-group" style="text-align:left">
        <label style="font-weight:bold;color:#2d3748;margin-bottom:5px;display:block">C√≥digo de Ativa√ß√£o</label>
        <input type="text" class="code-input" id="activationCode" placeholder="AA000000" maxlength="8">
      </div>
      <button class="login-btn" id="activateBtn" onclick="activateSystem()">Acessar Sistema</button>
    </div>

    <!-- LOGIN ADMIN (Email + Senha) -->
    <div id="adminLoginForm" style="display:none">
      <div class="info-box" style="background:#faf5ff;border-left-color:#805ad5;color:#553c9a">
        <strong>Acesso Administrativo:</strong><br>
        ‚Ä¢ Digite email e senha de administrador<br>
        ‚Ä¢ Visualize ativa√ß√µes e tentativas<br>
        ‚Ä¢ Gerencie c√≥digos do sistema
      </div>
      <div class="form-group" style="text-align:left">
        <label style="font-weight:bold;color:#2d3748;margin-bottom:5px;display:block">Email</label>
        <input type="email" id="adminEmail" placeholder="admin@asmgestao.com">
      </div>
      <div class="form-group" style="text-align:left">
        <label style="font-weight:bold;color:#2d3748;margin-bottom:5px;display:block">Senha</label>
        <input type="password" id="adminPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="login-btn" style="background:#805ad5" onclick="loginAdmin()">Acessar Painel Admin</button>
    </div>

    <div class="activation-error" id="activationError"></div>
    <div class="activation-success" id="activationSuccess">Acesso autorizado! Redirecionando...</div>
    <div id="activationLoading" style="display:none;margin-top:15px">
      <div class="loading"></div>
      <p style="margin-top:10px;color:#4a5568">Verificando...</p>
    </div>
    
    <p style="margin-top:20px;font-size:12px;color:#718096">
      ¬© 2024 ASM Gest√£o Cl√≠nica - Dra. Andresa Augusto<br>
      Proibida reprodu√ß√£o sem autoriza√ß√£o
    </p>
  </div>
</div>

<!-- SELE√á√ÉO DE PROFISSIONAL (Multicl√≠nica) -->
<div id="professionalSelectScreen" class="activation-container" style="display:none">
  <div class="activation-box" style="max-width:600px">
    <h2>üë• Selecione o Profissional</h2>
    <p>Este c√≥digo permite acesso a at√© 4 profissionais</p>
    <div class="info-box">
      <strong>C√≥digo ativado:</strong> <span id="displayActivatedCode"></span><br>
      <strong>CPF vinculado:</strong> <span id="displayActivatedCPF"></span>
    </div>
    
    <div id="professionalsList" class="professional-selector"></div>
    
    <button class="login-btn" onclick="confirmProfessionalSelection()" id="btnConfirmProf" style="display:none;margin-top:20px">
      Confirmar Acesso
    </button>
    
    <button class="login-btn" style="background:#718096;margin-top:10px" onclick="backToLogin()">
      ‚Üê Voltar
    </button>
  </div>
</div>

<!-- PAINEL ADMIN -->
<div id="adminPanel" style="display:none">
  <div class="header">
    <h1>üîê Painel Administrativo</h1>
    <p>Gerenciamento de Ativa√ß√µes - ASM Gest√£o Cl√≠nica</p>
  </div>
  
  <div class="user-bar">
    <div>üë§ Administrador</div>
    <div>
      <button onclick="showAdminSection('activations')" class="btn-admin" style="margin-right:10px">üìã Ver Ativa√ß√µes</button>
      <button onclick="showAdminSection('attempts')" class="btn-admin" style="margin-right:10px">‚ö†Ô∏è Tentativas</button>
      <button onclick="logoutAdmin()">üö™ Sair</button>
    </div>
  </div>

  <div class="container">
    <!-- Se√ß√£o Ativa√ß√µes -->
    <div id="adminActivations" class="section active">
      <h2>üìã C√≥digos Ativados</h2>
      <div class="admin-panel">
        <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
          <input type="text" id="searchActivation" placeholder="Buscar por CPF ou c√≥digo..." style="flex:1;padding:10px;border:1px solid #cbd5e0;border-radius:5px" oninput="filterActivations()">
          <select id="filterPlan" onchange="filterActivations()" style="padding:10px;border:1px solid #cbd5e0;border-radius:5px">
            <option value="">Todos os planos</option>
            <option value="basic">B√°sico</option>
            <option value="gold">Gold</option>
            <option value="premium">Premium</option>
          </select>
        </div>
        <table class="admin-table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Plano</th>
              <th>CPF</th>
              <th>Data Ativa√ß√£o</th>
              <th>Profissionais</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="activationsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Se√ß√£o Tentativas -->
    <div id="adminAttempts" class="section">
      <h2>‚ö†Ô∏è Tentativas de Burlar</h2>
      <div class="admin-panel">
        <p style="margin-bottom:15px;color:#718096">Registro de tentativas de uso de c√≥digo j√° ativado por outro CPF</p>
        <table class="admin-table">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>C√≥digo Tentado</th>
              <th>CPF do Tentante</th>
              <th>CPF Original</th>
              <th>Dispositivo</th>
            </tr>
          </thead>
          <tbody id="attemptsTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- SISTEMA PRINCIPAL -->
<div id="mainSystem" style="display:none">
  <div class="header">
    <h1>ASM Gest√£o Cl√≠nica</h1>
    <p id="headerSubtitle">Sistema de Gest√£o para Profissionais da Sa√∫de</p>
  </div>

  <div class="user-bar">
    <div>
      üë§ <span id="currentUserName">Profissional</span> | 
      <span id="currentUserSpecialty">---</span> | 
      <span id="currentUserRegistry">---</span>
    </div>
    <div>
      <button onclick="switchProfessional()" id="btnSwitchProf" style="display:none;margin-right:10px">üîÑ Trocar Profissional</button>
      <button onclick="logout()">üö™ Sair</button>
    </div>
  </div>

  <div class="nav">
    <button class="active" onclick="showSection('dashboard')">üìä Dashboard</button>
    <button onclick="showSection('agenda')">üìÖ Agenda</button>
    <button onclick="showSection('pacientes')">üë• Pacientes</button>
    <button onclick="showSection('financeiro')">üí∞ Financeiro</button>
    <button onclick="showSection('fluxo')">üìä Fluxo de Caixa</button>
    <button onclick="showSection('relatorios')">üìà Relat√≥rios</button>
    <button onclick="showSection('configuracoes')">‚öôÔ∏è Configura√ß√µes</button>
  </div>

  <div class="container">

    <!-- DASHBOARD -->
    <div id="dashboard" class="section active">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px">
        <h2>üìä Dashboard</h2>
        <button class="btn btn-pdf" onclick="generateDashboardPDF()">üìï Gerar PDF do Dashboard</button>
      </div>
      
      <div class="summary-cards">
        <div class="summary-card green">
          <h3 id="dashTotalRevenue">R$ 0,00</h3>
          <p>Faturamento Total</p>
        </div>
        <div class="summary-card blue">
          <h3 id="dashTotalSessions">0</h3>
          <p>Atendimentos</p>
        </div>
        <div class="summary-card purple">
          <h3 id="dashAvgTicket">R$ 0,00</h3>
          <p>Ticket M√©dio</p>
        </div>
        <div class="summary-card red">
          <h3 id="dashPending">R$ 0,00</h3>
          <p>A Receber</p>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3>üìà Faturamento por Tipo de Consulta</h3>
          <div class="chart-container">
            <canvas id="chartByType"></canvas>
          </div>
        </div>
        <div class="dashboard-card">
          <h3>üí≥ Faturamento por Forma de Pagamento</h3>
          <div class="chart-container">
            <canvas id="chartByPayment"></canvas>
          </div>
        </div>
      </div>

      <div class="dashboard-card" style="margin-top:20px">
        <h3>üìÖ Desempenho Mensal</h3>
        <div class="chart-container" style="height:250px">
          <canvas id="chartMonthly"></canvas>
        </div>
      </div>
    </div>

    <!-- CONFIGURA√á√ïES -->
    <div id="configuracoes" class="section">
      <h2>‚öôÔ∏è Configura√ß√µes do Profissional</h2>
      
      <div class="settings-box" id="profConfigBox">
        <h3 style="color:#1e3a5f;margin-bottom:15px">üë§ Dados do Profissional</h3>
        <div class="form-group">
          <label>Nome Completo *</label>
          <input type="text" id="configName" placeholder="Dr(a). Nome Completo">
        </div>
        <div class="form-group">
          <label>CPF *</label>
          <input type="text" id="configProfCPF" placeholder="000.000.000-00" maxlength="14" oninput="this.value=formatCPF(this.value)">
        </div>
        <div class="form-group">
          <label>Especialidade/Profiss√£o *</label>
          <select id="configProfession" onchange="updateRegistryLabel()">
            <option value="">Selecione...</option>
            <option value="fisioterapia">Fisioterapia</option>
            <option value="medicina">Medicina</option>
            <option value="nutricao">Nutri√ß√£o</option>
            <option value="psicologia">Psicologia</option>
            <option value="psicopedagogia">Psicopedagogia</option>
            <option value="fonoaudiologia">Fonoaudiologia</option>
            <option value="terapia_ocupacional">Terapia Ocupacional</option>
            <option value="estetica">Est√©tica</option>
            <option value="enfermagem">Enfermagem</option>
            <option value="odontologia">Odontologia</option>
            <option value="educacao_fisica">Educa√ß√£o F√≠sica</option>
          </select>
        </div>
        <div class="form-group">
          <label id="registryLabel">Registro Profissional *</label>
          <input type="text" id="configRegistry" placeholder="00 0000 F">
        </div>
        <div class="form-group">
          <label>Chave Pix</label>
          <input type="text" id="configPix" placeholder="CPF, CNPJ, e-mail ou telefone">
        </div>
      </div>

      <div class="settings-box" style="background:#f0fff4;border-left-color:#38a169">
        <h3 style="color:#276749;margin-bottom:15px">üè∑Ô∏è Tipos de Consulta e Valores</h3>
        <p style="font-size:13px;color:#718096;margin-bottom:15px">Configure os tipos de atendimento e seus valores padr√£o</p>
        <div id="consultationTypesList"></div>
        <button class="btn btn-success" onclick="addConsultationType()" style="margin-top:10px">+ Adicionar Tipo</button>
      </div>

      <div class="settings-box" style="background:#faf5ff;border-left-color:#805ad5">
        <h3 style="color:#553c9a;margin-bottom:15px">üè¢ Dados da Cl√≠nica</h3>
        <div class="form-group">
          <label>Nome da Cl√≠nica</label>
          <input type="text" id="configClinic" placeholder="ASM Sa√∫de">
        </div>
      </div>

      <button class="btn btn-primary" onclick="saveConfig()" style="margin-top:20px">üíæ Salvar Configura√ß√µes</button>

      <div style="margin-top:30px;padding:20px;background:#f7fafc;border-radius:8px">
        <h3 style="color:#1e3a5f;margin-bottom:15px">‚ÑπÔ∏è Informa√ß√µes da Conta</h3>
        <p><strong>C√≥digo de ativa√ß√£o:</strong> <span id="displayCode">---</span></p>
        <p><strong>Plano:</strong> <span id="displayPlan">---</span></p>
        <p style="margin-top:10px;font-size:12px;color:#718096">Dados salvos na nuvem Firebase.</p>
      </div>
    </div>

    <!-- AGENDA -->
    <div id="agenda" class="section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px">
        <h2>üìÖ Agenda</h2>
        <div style="display:flex;gap:10px">
          <button class="btn btn-primary" onclick="openAppointmentModal()">+ Novo Agendamento</button>
          <button class="btn btn-success" onclick="openRecurrenceModal()">üîÑ Recorr√™ncia</button>
        </div>
      </div>
      
      <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px;align-items:center">
        <button class="btn btn-primary" onclick="changeMonth(-1)">‚Üê Anterior</button>
        <h3 id="currentMonth" style="text-transform:capitalize;min-width:200px;text-align:center"></h3>
        <button class="btn btn-primary" onclick="changeMonth(1)">Pr√≥ximo ‚Üí</button>
      </div>
      
      <div class="calendar" id="calendar"></div>
    </div>

    <!-- PACIENTES -->
    <div id="pacientes" class="section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2>üë• Pacientes</h2>
        <button class="btn btn-primary" onclick="openPatientModal()">+ Novo Paciente</button>
      </div>
      <input type="text" style="width:100%;padding:10px;margin-bottom:20px;border:1px solid #cbd5e0;border-radius:5px" placeholder="üîç Buscar paciente..." oninput="searchPatients(this.value)">
      <div class="grid" id="patientsList"></div>
    </div>

    <!-- FINANCEIRO -->
    <div id="financeiro" class="section">
      <h2>üí∞ Financeiro</h2>
      <div class="summary-cards">
        <div class="summary-card green"><h3 id="totalReceived">R$ 0,00</h3><p>Recebido</p></div>
        <div class="summary-card red"><h3 id="totalPending">R$ 0,00</h3><p>A Receber</p></div>
        <div class="summary-card blue"><h3 id="totalSessions">0</h3><p>Total de Atendimentos</p></div>
      </div>
      
      <div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-whatsapp" onclick="sendSelectedPendingWhatsApp()" id="btnCobrarSelecionados" style="display:none">
          üì± Cobrar Selecionados (<span id="selectedCount">0</span>)
        </button>
        <button class="btn btn-primary" onclick="selectAllPending()">‚úì Selecionar Todos Pendentes</button>
        <button class="btn btn-warning" onclick="clearSelection()">‚úó Limpar Sele√ß√£o</button>
      </div>
      
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAllFinancial" onchange="toggleAllFinancial()"></th>
            <th>Paciente</th>
            <th>Data</th>
            <th>Servi√ßo</th>
            <th>Valor</th>
            <th>Forma Pag.</th>
            <th>Status</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="financialTable"></tbody>
      </table>
    </div>

    <!-- FLUXO DE CAIXA -->
    <div id="fluxo" class="section">
      <h2>üìä Fluxo de Caixa</h2>
      <div class="form-group" style="max-width:300px">
        <label>M√™s/Ano</label>
        <input type="month" id="cashFlowMonth" onchange="renderCashFlow()">
      </div>
      <div class="summary-cards">
        <div class="summary-card green"><h3 id="cfEntries">R$ 0,00</h3><p>Entradas</p></div>
        <div class="summary-card red"><h3 id="cfExits">R$ 0,00</h3><p>Sa√≠das</p></div>
        <div class="summary-card blue"><h3 id="cfBalance">R$ 0,00</h3><p>Saldo</p></div>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="showCashFlowTab('entries')">üí∞ Entradas</button>
        <button class="tab" onclick="showCashFlowTab('exits')">üí∏ Despesas</button>
        <button class="btn btn-danger" onclick="openExpenseModal()" style="margin-left:auto">+ Despesa</button>
      </div>
      <div id="cfEntriesTab" class="tab-content active">
        <table>
          <thead>
            <tr><th>Data</th><th>Paciente</th><th>Servi√ßo</th><th>Valor</th><th>Forma Pag.</th></tr>
          </thead>
          <tbody id="entriesTable"></tbody>
        </table>
      </div>
      <div id="cfExitsTab" class="tab-content">
        <table>
          <thead>
            <tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>A√ß√µes</th></tr>
          </thead>
          <tbody id="exitsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- RELAT√ìRIOS -->
    <div id="relatorios" class="section">
      <h2>üìà Relat√≥rios</h2>
      <div class="form-group" style="max-width:300px">
        <label>M√™s/Ano</label>
        <input type="month" id="reportMonth" onchange="renderReports()">
      </div>
      <div class="summary-cards">
        <div class="summary-card blue"><h3 id="reportSessions">0</h3><p>Atendimentos</p></div>
        <div class="summary-card green"><h3 id="reportRevenue">R$ 0,00</h3><p>Faturamento</p></div>
      </div>
      <div style="margin-bottom:20px">
        <button class="btn btn-pdf" onclick="generateMonthlyReportPDF()">üìï Gerar PDF do Relat√≥rio</button>
      </div>
      <table>
        <thead>
          <tr><th>Paciente</th><th>Sess√µes</th><th>Total</th></tr>
        </thead>
        <tbody id="reportTable"></tbody>
      </table>
    </div>

  </div>

  <!-- MODAL DE AGENDAMENTO -->
  <div class="modal" id="appointmentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Agendamento</h3>
        <button class="close-btn" onclick="closeModal('appointmentModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>Paciente *</label>
        <select id="apptPatient"></select>
      </div>
      <div class="form-group">
        <label>Data *</label>
        <input type="date" id="apptDate">
      </div>
      <div class="form-group">
        <label>Hor√°rio *</label>
        <input type="time" id="apptTime">
      </div>
      <div class="form-group">
        <label>Tipo de Atendimento</label>
        <select id="apptType" onchange="updateApptValue()"></select>
      </div>
      <div class="form-group">
        <label>Valor (R$)</label>
        <input type="number" id="apptValue" step="0.01" placeholder="0,00">
      </div>
      
      <div class="form-group">
        <label>Forma de Pagamento</label>
        <div class="payment-method">
          <label><input type="radio" name="paymentMethod" value="pix" checked> üí† Pix</label>
          <label><input type="radio" name="paymentMethod" value="cartao"> üí≥ Cart√£o</label>
          <label><input type="radio" name="paymentMethod" value="dinheiro"> üíµ Dinheiro</label>
        </div>
      </div>

      <div class="form-group">
        <label>Observa√ß√µes</label>
        <textarea id="apptNotes" rows="3"></textarea>
      </div>
      
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-whatsapp" id="btnWhatsAppt" onclick="sendAppointmentWhatsApp()" style="display:none">üì± WhatsApp</button>
        <button class="btn btn-danger" id="btnDeleteAppt" onclick="deleteAppointment()" style="display:none">üóë Excluir</button>
        <button class="btn btn-primary" onclick="saveAppointment()" style="margin-left:auto">üíæ Salvar</button>
      </div>
    </div>
  </div>

  <!-- MODAL DE RECORR√äNCIA -->
  <div class="modal" id="recurrenceModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üîÑ Agendamento Recorrente</h3>
        <button class="close-btn" onclick="closeModal('recurrenceModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>Paciente *</label>
        <select id="recPatient"></select>
      </div>
      <div class="form-group">
        <label>Data Inicial *</label>
        <input type="date" id="recStartDate">
      </div>
      <div class="form-group">
        <label>Hor√°rio *</label>
        <input type="time" id="recTime">
      </div>
      <div class="form-group">
        <label>Repetir por *</label>
        <select id="recWeeks">
          <option value="4">4 semanas (1 m√™s)</option>
          <option value="8">8 semanas (2 meses)</option>
          <option value="12">12 semanas (3 meses)</option>
          <option value="24">24 semanas (6 meses)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Tipo de Atendimento</label>
        <select id="recType" onchange="updateRecValue()"></select>
      </div>
      <div class="form-group">
        <label>Valor (R$)</label>
        <input type="number" id="recValue" step="0.01" placeholder="0,00">
      </div>
      <div class="recurrence-options">
        <p style="font-size:13px;color:#718096;margin-bottom:10px">Ser√£o criados agendamentos semanais automaticamente</p>
        <div id="recPreview" style="font-size:12px;color:#2d3748"></div>
      </div>
      <button class="btn btn-success" onclick="saveRecurrence()" style="width:100%;margin-top:15px">Criar Agendamentos Recorrentes</button>
    </div>
  </div>

  <!-- MODAL DE PACIENTE -->
  <div class="modal" id="patientModal">
    <div class="modal-content" style="max-width:700px">
      <div class="modal-header">
        <h3 id="patientModalTitle">Novo Paciente</h3>
        <button class="close-btn" onclick="closeModal('patientModal')">&times;</button>
      </div>

      <div class="patient-tabs">
        <button class="patient-tab-btn active" onclick="showPatientTab('info')" id="btnTabInfo">
          <span class="emoji">üë§</span>
          <span class="label">Informa√ß√µes</span>
        </button>
        <button class="patient-tab-btn" onclick="showPatientTab('financeiro')" id="btnTabFinanceiro">
          <span class="emoji">üí∞</span>
          <span class="label">Financeiro</span>
        </button>
        <button class="patient-tab-btn" onclick="showPatientTab('evolucao')" id="btnTabEvolucao">
          <span class="emoji">üìã</span>
          <span class="label">Evolu√ß√£o</span>
        </button>
        <button class="patient-tab-btn" onclick="showPatientTab('relatorio')" id="btnTabRelatorio">
          <span class="emoji">üìÑ</span>
          <span class="label">Relat√≥rio</span>
        </button>
      </div>

      <div id="tabInfo" class="tab-content active">
        <input type="hidden" id="patientId">
        <div class="form-group">
          <label>Nome Completo *</label>
          <input type="text" id="patientName">
        </div>
        <div class="form-group">
          <label>Telefone *</label>
          <input type="tel" id="patientPhone" placeholder="(00) 00000-0000">
        </div>
        <div class="form-group">
          <label>E-mail</label>
          <input type="email" id="patientEmail" placeholder="opcional">
        </div>
        <div class="form-group">
          <label>Valor Padr√£o da Consulta (R$)</label>
          <input type="number" id="patientValue" step="0.01" placeholder="0,00">
        </div>
        <div class="form-group">
          <label>Queixa Principal / Motivo da Consulta</label>
          <textarea id="patientComplaint" rows="3" placeholder="Descreva a queixa principal..."></textarea>
        </div>
      </div>

      <div id="tabFinanceiro" class="tab-content">
        <div class="summary-cards">
          <div class="summary-card green"><h3 id="patientPaid">R$ 0,00</h3><p>Pago</p></div>
          <div class="summary-card red"><h3 id="patientPending">R$ 0,00</h3><p>Pendente</p></div>
        </div>
        <div style="margin-bottom:15px">
          <button class="btn btn-whatsapp" onclick="sendPendingSessionsWhatsApp()">üì± Cobrar Selecionadas</button>
        </div>
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllSessions" onchange="toggleAllSessions()"></th>
              <th>Data</th>
              <th>Servi√ßo</th>
              <th>Valor</th>
              <th>Forma Pag.</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="patientFinanceTable"></tbody>
        </table>
      </div>

      <div id="tabEvolucao" class="tab-content">
        <div class="form-group">
          <label>Nova Evolu√ß√£o / Anota√ß√£o</label>
          <textarea id="newEvolution" rows="4" placeholder="Descreva a evolu√ß√£o do paciente..."></textarea>
          <button class="btn btn-primary" onclick="addEvolution()" style="margin-top:10px">üíæ Salvar Evolu√ß√£o</button>
        </div>
        <div id="evolutionsList"></div>
      </div>

      <div id="tabRelatorio" class="tab-content">
        <div class="form-group">
          <label>M√™s/Ano do Relat√≥rio</label>
          <input type="month" id="reportMonthPatient">
        </div>
        <button class="btn btn-primary" onclick="generatePatientReport()">üìÑ Gerar Relat√≥rio</button>
        <div id="reportContainer" style="display:none;margin-top:20px">
          <div class="report-box" id="reportContent"></div>
          <div style="display:flex;gap:10px;margin-top:15px;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="copyReport()">üìã Copiar Texto</button>
            <button class="btn btn-whatsapp" onclick="sendReportWhatsApp()">üì± WhatsApp</button>
            <button class="btn btn-pdf" onclick="generatePDFReport()">üìï Gerar PDF</button>
          </div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;margin-top:20px;padding-top:20px;border-top:2px solid #e2e8f0">
        <button class="btn btn-danger" id="btnDeletePatient" onclick="deletePatient()" style="display:none">üóë Excluir Paciente</button>
        <button class="btn btn-primary" onclick="savePatient()">üíæ Salvar Paciente</button>
      </div>
    </div>
  </div>

  <!-- MODAL DE DESPESA -->
  <div class="modal" id="expenseModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Nova Despesa</h3>
        <button class="close-btn" onclick="closeModal('expenseModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>Data *</label>
        <input type="date" id="expenseDate">
      </div>
      <div class="form-group">
        <label>Descri√ß√£o *</label>
        <input type="text" id="expenseDesc" placeholder="Ex: Material de escrit√≥rio">
      </div>
      <div class="form-group">
        <label>Categoria</label>
        <select id="expenseCategory">
          <option value="material">Material</option>
          <option value="aluguel">Aluguel</option>
          <option value="servicos">Servi√ßos</option>
          <option value="outros">Outros</option>
        </select>
      </div>
      <div class="form-group">
        <label>Valor (R$) *</label>
        <input type="number" id="expenseValue" step="0.01" placeholder="0,00">
      </div>
      <button class="btn btn-primary" onclick="saveExpense()">üíæ Salvar Despesa</button>
    </div>
  </div>

  <div class="footer">
    <p><strong>ASM Gest√£o Cl√≠nica</strong></p>
    <p>¬© 2024 Dra. Andresa Augusto - Todos os direitos reservados</p>
    <p>Proibida reprodu√ß√£o sem autoriza√ß√£o</p>
  </div>
</div>

<script>
// CONFIGURA√á√ÉO FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyDAP8Krf1QYRUf2VmgeGRXL6eoceVcDnp4",
  authDomain: "asm-gestao-clinica.firebaseapp.com",
  databaseURL: "https://asm-gestao-clinica-default-rtdb.firebaseio.com",
  projectId: "asm-gestao-clinica",
  storageBucket: "asm-gestao-clinica.firebasestorage.app",
  messagingSenderId: "846179775289",
  appId: "1:846179775289:web:b914c4e024b1fb13a66ee8"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// VARI√ÅVEIS GLOBAIS
let currentUserCPF = '';
let currentActivationCode = '';
let currentPlan = '';
let userDataPath = '';
let currentProfessionalId = null;
let isAdmin = false;
let config = {};
let patients = [];
let appointments = [];
let evolutions = [];
let expenses = [];
let consultationTypes = [];
let currentDate = new Date();
let currentPatientId = null;
let currentApptId = null;
let currentReport = '';
let selectedSessions = new Set();
let selectedFinancial = new Set();
let clinicProfessionals = [];

const professionConfig = {
  fisioterapia: { name: 'Fisioterapia', registry: 'CREFITO', placeholder: '00 0000 F' },
  medicina: { name: 'Medicina', registry: 'CRM', placeholder: '00 0000' },
  nutricao: { name: 'Nutri√ß√£o', registry: 'CRN', placeholder: '00 0000' },
  psicologia: { name: 'Psicologia', registry: 'CRP', placeholder: '00 0000' },
  psicopedagogia: { name: 'Psicopedagogia', registry: 'CRP/CREFITO', placeholder: '00 0000' },
  fonoaudiologia: { name: 'Fonoaudiologia', registry: 'CREFONO', placeholder: '00 0000 F' },
  terapia_ocupacional: { name: 'Terapia Ocupacional', registry: 'CREFITO', placeholder: '00 0000 TO' },
  estetica: { name: 'Est√©tica', registry: 'COREN/CREFITO', placeholder: '00 0000' },
  enfermagem: { name: 'Enfermagem', registry: 'COREN', placeholder: '00 0000' },
  odontologia: { name: 'Odontologia', registry: 'CRO', placeholder: '00 0000' },
  educacao_fisica: { name: 'Educa√ß√£o F√≠sica', registry: 'CREF', placeholder: '00 0000' }
};

const defaultConsultationTypes = [
  { id: 'consulta', name: 'Consulta', value: 150 },
  { id: 'avaliacao', name: 'Avalia√ß√£o', value: 200 },
  { id: 'retorno', name: 'Retorno', value: 100 }
];

// INICIALIZA√á√ÉO
window.onload = function() {
  const savedCPF = localStorage.getItem('asm_user_cpf');
  const savedCode = localStorage.getItem('asm_activation_code');
  const savedProfId = localStorage.getItem('asm_professional_id');
  
  if (savedCPF && savedCode) {
    currentUserCPF = savedCPF;
    currentActivationCode = savedCode;
    userDataPath = 'clinics/' + currentActivationCode;
    
    if (savedProfId) {
      currentProfessionalId = savedProfId;
      loadDataFromFirebase();
    } else {
      loadProfessionalsList();
    }
  }
};

// FUN√á√ïES DE LOGIN
function showLoginType(type) {
  document.querySelectorAll('.login-type-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById('userLoginForm').style.display = 'none';
  document.getElementById('adminLoginForm').style.display = 'none';
  
  if (type === 'user') {
    document.getElementById('btnUserLogin').classList.add('active');
    document.getElementById('userLoginForm').style.display = 'block';
  } else {
    document.getElementById('btnAdminLogin').classList.add('active');
    document.getElementById('adminLoginForm').style.display = 'block';
  }
}

function formatCPF(cpf) {
  cpf = cpf.replace(/\D/g, '');
  if (cpf.length <= 11) {
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
  }
  return cpf;
}

async function activateSystem() {
  const cpf = document.getElementById('userCPF').value.trim();
  const code = document.getElementById('activationCode').value.toUpperCase().trim();
  const errorMsg = document.getElementById('activationError');
  const loading = document.getElementById('activationLoading');
  const btn = document.getElementById('activateBtn');
  
  errorMsg.style.display = 'none';
  document.getElementById('activationSuccess').style.display = 'none';
  
  const cpfNumbers = cpf.replace(/\D/g, '');
  if (cpfNumbers.length !== 11) {
    errorMsg.textContent = 'CPF inv√°lido! Digite os 11 n√∫meros.';
    errorMsg.style.display = 'block';
    return;
  }
  
  if (!code || code.length < 8 || !code.startsWith('AA')) {
    errorMsg.textContent = 'C√≥digo inv√°lido! Use o formato AA000000';
    errorMsg.style.display = 'block';
    return;
  }
  
  loading.style.display = 'block';
  btn.disabled = true;
  
  try {
    const codeRef = database.ref('activationCodes/' + code);
    const snapshot = await codeRef.once('value');
    
    if (!snapshot.exists()) {
      errorMsg.textContent = 'C√≥digo de ativa√ß√£o n√£o encontrado!';
      errorMsg.style.display = 'block';
    } else {
      const codeData = snapshot.val();
      
      if (codeData.used && codeData.cpf !== cpfNumbers) {
        await logBreachAttempt(code, cpfNumbers, codeData.cpf);
        errorMsg.textContent = 'Este c√≥digo j√° foi utilizado por outro CPF!';
        errorMsg.style.display = 'block';
      } else {
        if (!codeData.used) {
          await codeRef.update({
            used: true,
            cpf: cpfNumbers,
            activatedAt: new Date().toISOString(),
            plan: codeData.plan || 'basic'
          });
        }
        
        currentUserCPF = cpf;
        currentActivationCode = code;
        currentPlan = codeData.plan || 'basic';
        userDataPath = 'clinics/' + code;
        
        localStorage.setItem('asm_user_cpf', cpf);
        localStorage.setItem('asm_activation_code', code);
        localStorage.setItem('asm_plan', currentPlan);
        
        document.getElementById('activationSuccess').style.display = 'block';
        setTimeout(() => {
          loadProfessionalsList();
        }, 1000);
      }
    }
  } catch (error) {
    errorMsg.textContent = 'Erro de conex√£o: ' + error.message;
    errorMsg.style.display = 'block';
  } finally {
    loading.style.display = 'none';
    btn.disabled = false;
  }
}

async function logBreachAttempt(code, attemptedCPF, originalCPF) {
  const attemptData = {
    code: code,
    attemptedCPF: attemptedCPF,
    originalCPF: originalCPF,
    timestamp: new Date().toISOString(),
    userAgent: navigator.userAgent
  };
  await database.ref('breachAttempts').push(attemptData);
}

async function loginAdmin() {
  const email = document.getElementById('adminEmail').value.trim();
  const password = document.getElementById('adminPassword').value;
  const errorMsg = document.getElementById('activationError');
  
  const adminEmail = "admin@asmgestao.com";
  const adminPass = "asm2024admin";
  
  if (email === adminEmail && password === adminPass) {
    isAdmin = true;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    loadAdminData();
  } else {
    errorMsg.textContent = 'Email ou senha incorretos!';
    errorMsg.style.display = 'block';
  }
}

function logoutAdmin() {
  isAdmin = false;
  location.reload();
}

async function loadAdminData() {
  const snapshot = await database.ref('activationCodes').once('value');
  const codes = snapshot.val() || {};
  
  const tbody = document.getElementById('activationsTable');
  tbody.innerHTML = '';
  
  Object.entries(codes).forEach(([code, data]) => {
    if (data.used) {
      const row = document.createElement('tr');
      const profCount = data.professionals ? Object.keys(data.professionals).length : 0;
      row.innerHTML = `
        <td>${code}</td>
        <td>${data.plan || 'basic'}</td>
        <td>${formatCPF(data.cpf || '')}</td>
        <td>${data.activatedAt ? new Date(data.activatedAt).toLocaleDateString('pt-BR') : '-'}</td>
        <td>${profCount}/4</td>
        <td style="color:green">‚úì Ativo</td>
      `;
      tbody.appendChild(row);
    }
  });
  
  const attemptsSnapshot = await database.ref('breachAttempts').once('value');
  const attempts = attemptsSnapshot.val() || {};
  
  const attemptsBody = document.getElementById('attemptsTable');
  attemptsBody.innerHTML = '';
  
  Object.entries(attempts).forEach(([id, data]) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${new Date(data.timestamp).toLocaleString('pt-BR')}</td>
      <td>${data.code}</td>
      <td>${formatCPF(data.attemptedCPF)}</td>
      <td>${formatCPF(data.originalCPF)}</td>
      <td>${data.userAgent.substring(0, 50)}...</td>
    `;
    attemptsBody.appendChild(row);
  });
}

function showAdminSection(section) {
  document.querySelectorAll('#adminPanel .section').forEach(s => s.classList.remove('active'));
  document.getElementById('admin' + (section === 'activations' ? 'Activations' : 'Attempts')).classList.add('active');
}

function filterActivations() {
  loadAdminData();
}

// MULTICL√çNICA
async function loadProfessionalsList() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('professionalSelectScreen').style.display = 'flex';
  document.getElementById('displayActivatedCode').textContent = currentActivationCode;
  document.getElementById('displayActivatedCPF').textContent = currentUserCPF;
  
  const snapshot = await database.ref(userDataPath + '/professionals').once('value');
  const professionals = snapshot.val() || {};
  
  const container = document.getElementById('professionalsList');
  container.innerHTML = '';
  
  clinicProfessionals = [];
  
  if (Object.keys(professionals).length === 0) {
    for (let i = 0; i < 4; i++) {
      createProfessionalSlot(container, i, null);
    }
  } else {
    Object.entries(professionals).forEach(([id, prof]) => {
      clinicProfessionals.push({id, ...prof});
      createProfessionalSlot(container, id, prof);
    });
    for (let i = Object.keys(professionals).length; i < 4; i++) {
      createProfessionalSlot(container, i, null);
    }
  }
}

function createProfessionalSlot(container, index, prof) {
  const card = document.createElement('div');
  card.className = 'professional-card';
  card.onclick = () => selectProfessional(index, card);
  
  if (prof && prof.name) {
    const profConfig = professionConfig[prof.profession] || { name: prof.profession, registry: 'Registro' };
    card.innerHTML = `
      <div class="icon">üë§</div>
      <div class="name">${prof.name}</div>
      <div class="specialty">${profConfig.name}</div>
      <div style="font-size:11px;margin-top:5px">${profConfig.registry} ${prof.registry || ''}</div>
    `;
    card.dataset.profId = index;
  } else {
    card.innerHTML = `
      <div class="icon" style="opacity:0.3">‚ûï</div>
      <div class="name" style="opacity:0.5">Novo Profissional</div>
      <div class="specialty">Clique para cadastrar</div>
    `;
    card.dataset.profId = 'new_' + index;
  }
  
  container.appendChild(card);
}

let selectedProfId = null;

function selectProfessional(index, cardElement) {
  document.querySelectorAll('.professional-card').forEach(c => c.classList.remove('selected'));
  cardElement.classList.add('selected');
  selectedProfId = cardElement.dataset.profId;
  document.getElementById('btnConfirmProf').style.display = 'block';
}

async function confirmProfessionalSelection() {
  if (!selectedProfId) return;
  
  currentProfessionalId = selectedProfId.startsWith('new_') ? selectedProfId.replace('new_', '') : selectedProfId;
  localStorage.setItem('asm_professional_id', currentProfessionalId);
  
  if (selectedProfId.startsWith('new_')) {
    showMainSystem();
    showSection('configuracoes');
    alert('Configure os dados do novo profissional');
  } else {
    loadDataFromFirebase();
  }
}

function backToLogin() {
  localStorage.clear();
  location.reload();
}

function switchProfessional() {
  localStorage.removeItem('asm_professional_id');
  loadProfessionalsList();
}

// CARREGAMENTO DE DADOS
async function loadDataFromFirebase() {
  try {
    const clinicSnapshot = await database.ref(userDataPath).once('value');
    const clinicData = clinicSnapshot.val() || {};
    
    appointments = clinicData.appointments || [];
    patients = clinicData.patients || [];
    expenses = clinicData.expenses || [];
    
    const profSnapshot = await database.ref(userDataPath + '/professionals/' + currentProfessionalId).once('value');
    const profData = profSnapshot.val() || {};
    
    config = profData.config || {};
    evolutions = profData.evolutions || [];
    consultationTypes = profData.consultationTypes || defaultConsultationTypes;
    
    if (!config.name) {
      showMainSystem();
      showSection('configuracoes');
      alert('Bem-vindo! Configure seus dados para come√ßar.');
    } else {
      showMainSystem();
    }
  } catch (error) {
    showMainSystem();
  }
}

async function saveDataToFirebase() {
  try {
    const clinicData = {
      appointments: appointments,
      patients: patients,
      expenses: expenses,
      lastUpdate: new Date().toISOString()
    };
    await database.ref(userDataPath).update(clinicData);
    
    const profData = {
      config: config,
      evolutions: evolutions,
      consultationTypes: consultationTypes,
      lastUpdate: new Date().toISOString()
    };
    await database.ref(userDataPath + '/professionals/' + currentProfessionalId).set(profData);
    
    return true;
  } catch (error) {
    alert('Erro ao salvar dados: ' + error.message);
    return false;
  }
}

function showMainSystem() {
  document.getElementById('professionalSelectScreen').style.display = 'none';
  document.getElementById('mainSystem').style.display = 'block';
  document.getElementById('displayCode').textContent = currentActivationCode;
  document.getElementById('displayPlan').textContent = currentPlan.toUpperCase();
  
  if (clinicProfessionals.length > 1) {
    document.getElementById('btnSwitchProf').style.display = 'inline-block';
  }
  
  initializeApp();
}

function logout() {
  localStorage.clear();
  location.reload();
}

async function initializeApp() {
  loadConfig();
  updateHeader();
  updateUserBar();
  renderCalendar();
  renderPatients();
  updateFinancialSummary();
  loadPatientSelect();
  loadRecurrenceSelect();
  renderConsultationTypes();
  updateDashboard();
  
  const today = new Date().toISOString().slice(0, 7);
  document.getElementById('cashFlowMonth').value = today;
  document.getElementById('reportMonth').value = today;
}

function updateRegistryLabel() {
  const profession = document.getElementById('configProfession').value;
  const label = document.getElementById('registryLabel');
  const input = document.getElementById('configRegistry');
  
  if (profession && professionConfig[profession]) {
    const prof = professionConfig[profession];
    label.textContent = prof.registry + ' *';
    input.placeholder = prof.placeholder;
  } else {
    label.textContent = 'Registro Profissional *';
    input.placeholder = '00000';
  }
}

function loadConfig() {
  document.getElementById('configProfession').value = config.profession || '';
  document.getElementById('configName').value = config.name || '';
  document.getElementById('configRegistry').value = config.registry || '';
  document.getElementById('configPix').value = config.pix || '';
  document.getElementById('configClinic').value = config.clinic || 'ASM Sa√∫de';
  document.getElementById('configProfCPF').value = config.cpf || '';
  updateRegistryLabel();
}

async function saveConfig() {
  const profession = document.getElementById('configProfession').value;
  if (!profession) { alert('Selecione sua profiss√£o!'); return; }
  
  config = {
    profession: profession,
    name: document.getElementById('configName').value.trim(),
    cpf: document.getElementById('configProfCPF').value.trim(),
    registry: document.getElementById('configRegistry').value.trim(),
    pix: document.getElementById('configPix').value.trim(),
    clinic: document.getElementById('configClinic').value.trim() || 'ASM Sa√∫de'
  };
  
  if (!config.name || !config.registry || !config.cpf) { 
    alert('Preencha nome, CPF e registro profissional!'); 
    return; 
  }
  
  await saveDataToFirebase();
  updateHeader();
  updateUserBar();
  alert('Configura√ß√µes salvas com sucesso!');
}

function updateHeader() {
  const subtitle = document.getElementById('headerSubtitle');
  const profConfig = professionConfig[config.profession];
  
  if (profConfig) {
    subtitle.textContent = (config.name ? config.name + ' - ' : '') + profConfig.name;
  } else {
    subtitle.textContent = config.name || 'Configure seus dados';
  }
}

function updateUserBar() {
  document.getElementById('currentUserName').textContent = config.name || 'Profissional';
  document.getElementById('currentUserRegistry').textContent = config.registry || '---';
  
  const profConfig = professionConfig[config.profession];
  document.getElementById('currentUserSpecialty').textContent = profConfig ? profConfig.name : '---';
}

function getProfessionalSignature() {
  const profConfig = professionConfig[config.profession] || { registry: 'Registro' };
  return {
    name: config.name || 'Profissional',
    registry: config.registry ? profConfig.registry + ' ' + config.registry : '',
    clinic: config.clinic || 'ASM Sa√∫de',
    pix: config.pix || ''
  };
}

// TIPOS DE CONSULTA
function renderConsultationTypes() {
  const container = document.getElementById('consultationTypesList');
  if (!container) return;
  
  container.innerHTML = '';
  consultationTypes.forEach((type, index) => {
    const div = document.createElement('div');
    div.className = 'consultation-type-item';
    div.innerHTML = `
      <input type="text" placeholder="Nome" value="${type.name}" onchange="updateConsultationType(${index}, 'name', this.value)" style="flex:2">
      <input type="number" placeholder="Valor" value="${type.value}" onchange="updateConsultationType(${index}, 'value', this.value)" style="flex:1">
      <button onclick="removeConsultationType(${index})">üóë</button>
    `;
    container.appendChild(div);
  });
  
  updateApptTypeSelect();
}

function updateConsultationType(index, field, value) {
  if (field === 'value') value = parseFloat(value) || 0;
  consultationTypes[index][field] = value;
  saveDataToFirebase();
  updateApptTypeSelect();
}

function removeConsultationType(index) {
  if (consultationTypes.length <= 1) {
    alert('Mantenha pelo menos um tipo de consulta!');
    return;
  }
  consultationTypes.splice(index, 1);
  renderConsultationTypes();
  saveDataToFirebase();
}

function addConsultationType() {
  consultationTypes.push({ id: 'custom_' + Date.now(), name: 'Novo Tipo', value: 0 });
  renderConsultationTypes();
}

function updateApptTypeSelect() {
  const selects = ['apptType', 'recType'];
  selects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    const currentValue = select.value;
    select.innerHTML = '';
    consultationTypes.forEach(type => {
      const opt = document.createElement('option');
      opt.value = type.id;
      opt.textContent = type.name + ' (R$ ' + type.value.toFixed(2) + ')';
      select.appendChild(opt);
    });
    if (currentValue) select.value = currentValue;
  });
}

function updateApptValue() {
  const typeId = document.getElementById('apptType').value;
  const type = consultationTypes.find(t => t.id === typeId);
  if (type) {
    document.getElementById('apptValue').value = type.value;
  }
}

function updateRecValue() {
  const typeId = document.getElementById('recType').value;
  const type = consultationTypes.find(t => t.id === typeId);
  if (type) {
    document.getElementById('recValue').value = type.value;
  }
}

// NAVEGA√á√ÉO
function showSection(section) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
  
  const sectionEl = document.getElementById(section);
  if (sectionEl) sectionEl.classList.add('active');
  
  const navButtons = document.querySelectorAll('.nav button');
  navButtons.forEach(btn => {
    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(section)) {
      btn.classList.add('active');
    }
  });
  
  if (section === 'financeiro') { 
    selectedFinancial.clear(); 
    renderFinancialTable(); 
  }
  if (section === 'fluxo') renderCashFlow();
  if (section === 'relatorios') renderReports();
  if (section === 'dashboard') updateDashboard();
}

// DASHBOARD
function updateDashboard() {
  const now = new Date();
  const currentMonth = now.toISOString().slice(0, 7);
  
  const monthAppts = appointments.filter(a => !a.cancelled && a.date.startsWith(currentMonth));
  const totalRevenue = monthAppts.reduce((s, a) => s + parseFloat(a.value || 0), 0);
  const pending = appointments.filter(a => !a.cancelled && !a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
  
  document.getElementById('dashTotalRevenue').textContent = 'R$ ' + totalRevenue.toFixed(2);
  document.getElementById('dashTotalSessions').textContent = monthAppts.length;
  document.getElementById('dashAvgTicket').textContent = 'R$ ' + (monthAppts.length > 0 ? (totalRevenue / monthAppts.length).toFixed(2) : '0.00');
  document.getElementById('dashPending').textContent = 'R$ ' + pending.toFixed(2);
  
  renderCharts();
}

function renderCharts() {
  const now = new Date();
  const currentMonth = now.toISOString().slice(0, 7);
  const monthAppts = appointments.filter(a => !a.cancelled && a.paid && a.date.startsWith(currentMonth));
  
  // Gr√°fico por tipo
  const byType = {};
  monthAppts.forEach(appt => {
    const typeName = getConsultationTypeName(appt.type);
    byType[typeName] = (byType[typeName] || 0) + parseFloat(appt.value || 0);
  });
  
  const ctxType = document.getElementById('chartByType');
  if (ctxType) {
    new Chart(ctxType, {
      type: 'pie',
      data: {
        labels: Object.keys(byType),
        datasets: [{
          data: Object.values(byType),
          backgroundColor: ['#1e3a5f', '#38a169', '#d69e2e', '#e53e3e', '#805ad5']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }
  
  // Gr√°fico por pagamento
  const byPayment = { Pix: 0, Cart√£o: 0, Dinheiro: 0 };
  monthAppts.forEach(appt => {
    const method = appt.paymentMethod || 'pix';
    const label = method === 'pix' ? 'Pix' : method === 'cartao' ? 'Cart√£o' : 'Dinheiro';
    byPayment[label] += parseFloat(appt.value || 0);
  });
  
  const ctxPayment = document.getElementById('chartByPayment');
  if (ctxPayment) {
    new Chart(ctxPayment, {
      type: 'doughnut',
      data: {
        labels: Object.keys(byPayment),
        datasets: [{
          data: Object.values(byPayment),
          backgroundColor: ['#1e3a5f', '#38a169', '#d69e2e']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }
  
  // Gr√°fico mensal
  const monthlyData = {};
  for (let i = 5; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const key = d.toISOString().slice(0, 7);
    monthlyData[key] = 0;
  }
  
  appointments.filter(a => !a.cancelled && a.paid).forEach(appt => {
    const month = appt.date.slice(0, 7);
    if (monthlyData.hasOwnProperty(month)) {
      monthlyData[month] += parseFloat(appt.value || 0);
    }
  });
  
  const ctxMonthly = document.getElementById('chartMonthly');
  if (ctxMonthly) {
    new Chart(ctxMonthly, {
      type: 'bar',
      data: {
        labels: Object.keys(monthlyData).map(m => {
          const [y, mon] = m.split('-');
          return mon + '/' + y;
        }),
        datasets: [{
          label: 'Faturamento (R$)',
          data: Object.values(monthlyData),
          backgroundColor: '#1e3a5f'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } }
      }
    });
  }
}

function getConsultationTypeName(typeId) {
  const type = consultationTypes.find(t => t.id === typeId);
  return type ? type.name : typeId;
}

// AGENDA
function renderCalendar() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  document.getElementById('currentMonth').textContent = new Date(year, month).toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const calendar = document.getElementById('calendar');
  calendar.innerHTML = '';
  
  const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
  days.forEach(day => {
    const div = document.createElement('div');
    div.className = 'calendar-header';
    div.textContent = day;
    calendar.appendChild(div);
  });
  
  for (let i = 0; i < firstDay; i++) { 
    calendar.appendChild(document.createElement('div')); 
  }
  
  const today = new Date();
  for (let day = 1; day <= daysInMonth; day++) {
    const div = document.createElement('div');
    div.className = 'calendar-day';
    div.innerHTML = '<strong>' + day + '</strong>';
    
    if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
      div.style.background = '#1e3a5f'; 
      div.style.color = 'white';
    }
    
    const dayAppointments = appointments.filter(a => {
      const parts = a.date.split('-');
      return parseInt(parts[0]) === year && (parseInt(parts[1]) - 1) === month && parseInt(parts[2]) === day && !a.cancelled;
    });
    
    dayAppointments.forEach(appt => {
      const patient = patients.find(p => p.id === appt.patientId);
      const prof = clinicProfessionals.find(p => p.id === appt.professionalId);
      const apptDiv = document.createElement('div');
      apptDiv.className = 'appointment';
      apptDiv.innerHTML = '<span>' + appt.time + ' ' + (patient ? patient.name.split(' ')[0] : '') + (prof && prof.id !== currentProfessionalId ? ' (' + prof.name.charAt(0) + ')' : '') + '</span>';
      apptDiv.onclick = (e) => { e.stopPropagation(); editAppointment(appt.id); };
      div.appendChild(apptDiv);
    });
    
    div.onclick = () => openAppointmentModal(year, month, day);
    calendar.appendChild(div);
  }
}

function changeMonth(delta) {
  currentDate.setMonth(currentDate.getMonth() + delta);
  renderCalendar();
}

function openAppointmentModal(year, month, day) {
  currentApptId = null;
  document.getElementById('apptPatient').value = '';
  document.getElementById('apptTime').value = '';
  document.getElementById('apptNotes').value = '';
  document.getElementById('btnWhatsAppt').style.display = 'none';
  document.getElementById('btnDeleteAppt').style.display = 'none';
  document.querySelector('input[name="paymentMethod"][value="pix"]').checked = true;
  
  if (year !== undefined) {
    document.getElementById('apptDate').value = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
  } else {
    document.getElementById('apptDate').value = new Date().toISOString().split('T')[0];
  }
  
  if (consultationTypes.length > 0) {
    document.getElementById('apptType').value = consultationTypes[0].id;
    document.getElementById('apptValue').value = consultationTypes[0].value;
  }
  
  document.getElementById('appointmentModal').classList.add('active');
}

function editAppointment(id) {
  const appt = appointments.find(a => a.id === id);
  if (!appt) return;
  
  currentApptId = id;
  document.getElementById('apptPatient').value = appt.patientId;
  document.getElementById('apptDate').value = appt.date;
  document.getElementById('apptTime').value = appt.time;
  document.getElementById('apptType').value = appt.type;
  document.getElementById('apptValue').value = appt.value;
  document.getElementById('apptNotes').value = appt.notes || '';
  
  const paymentMethod = appt.paymentMethod || 'pix';
  const radio = document.querySelector('input[name="paymentMethod"][value="' + paymentMethod + '"]');
  if (radio) radio.checked = true;
  
  document.getElementById('btnWhatsAppt').style.display = 'inline-block';
  document.getElementById('btnDeleteAppt').style.display = 'inline-block';
  document.getElementById('appointmentModal').classList.add('active');
}

async function saveAppointment() {
  const patientId = document.getElementById('apptPatient').value;
  if (!patientId) { alert('Selecione um paciente!'); return; }
  
  const patient = patients.find(p => p.id === patientId);
  const typeId = document.getElementById('apptType').value;
  const type = consultationTypes.find(t => t.id === typeId);
  
  const data = {
    id: currentApptId || Date.now().toString(),
    patientId: patientId,
    professionalId: currentProfessionalId,
    date: document.getElementById('apptDate').value,
    time: document.getElementById('apptTime').value,
    type: typeId,
    typeName: type ? type.name : typeId,
    value: parseFloat(document.getElementById('apptValue').value) || 0,
    notes: document.getElementById('apptNotes').value,
    paid: currentApptId ? (appointments.find(a => a.id === currentApptId)?.paid || false) : false,
    cancelled: false,
    paymentMethod: document.querySelector('input[name="paymentMethod"]:checked')?.value || 'pix'
  };
  
  if (currentApptId) {
    const idx = appointments.findIndex(a => a.id === currentApptId);
    appointments[idx] = data;
  } else { 
    appointments.push(data); 
  }
  
  await saveDataToFirebase();
  closeModal('appointmentModal');
  renderCalendar();
  updateFinancialSummary();
  updateDashboard();
}

async function deleteAppointment() {
  if (!currentApptId) return;
  if (!confirm('Tem certeza que deseja excluir este agendamento?')) return;
  
  appointments = appointments.filter(a => a.id !== currentApptId);
  
  await saveDataToFirebase();
  closeModal('appointmentModal');
  renderCalendar();
  updateFinancialSummary();
  updateDashboard();
}

// RECORR√äNCIA
function openRecurrenceModal() {
  document.getElementById('recPatient').value = '';
  document.getElementById('recStartDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('recTime').value = '';
  document.getElementById('recWeeks').value = '4';
  
  if (consultationTypes.length > 0) {
    document.getElementById('recType').value = consultationTypes[0].id;
    document.getElementById('recValue').value = consultationTypes[0].value;
  }
  
  updateRecurrencePreview();
  document.getElementById('recurrenceModal').classList.add('active');
}

function loadRecurrenceSelect() {
  const select = document.getElementById('recPatient');
  if (!select) return;
  
  select.innerHTML = '<option value="">Selecione...</option>';
  patients.sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name;
    select.appendChild(opt);
  });
}

function updateRecurrencePreview() {
  const startDate = document.getElementById('recStartDate').value;
  const weeks = parseInt(document.getElementById('recWeeks').value) || 4;
  
  if (!startDate) {
    document.getElementById('recPreview').textContent = 'Selecione a data inicial';
    return;
  }
  
  let preview = 'Datas agendadas:\n';
  const start = new Date(startDate);
  
  for (let i = 0; i < weeks; i++) {
    const date = new Date(start);
    date.setDate(date.getDate() + (i * 7));
    preview += '‚Ä¢ ' + date.toLocaleDateString('pt-BR') + '\n';
  }
  
  document.getElementById('recPreview').textContent = preview;
}

document.getElementById('recStartDate')?.addEventListener('change', updateRecurrencePreview);
document.getElementById('recWeeks')?.addEventListener('change', updateRecurrencePreview);

async function saveRecurrence() {
  const patientId = document.getElementById('recPatient').value;
  if (!patientId) { alert('Selecione um paciente!'); return; }
  
  const startDate = document.getElementById('recStartDate').value;
  const time = document.getElementById('recTime').value;
  const weeks = parseInt(document.getElementById('recWeeks').value) || 4;
  const typeId = document.getElementById('recType').value;
  const type = consultationTypes.find(t => t.id === typeId);
  const value = parseFloat(document.getElementById('recValue').value) || 0;
  
  if (!startDate || !time) { alert('Preencha data e hor√°rio!'); return; }
  
  const start = new Date(startDate);
  const newAppointments = [];
  
  for (let i = 0; i < weeks; i++) {
    const date = new Date(start);
    date.setDate(date.getDate() + (i * 7));
    
    newAppointments.push({
      id: Date.now().toString() + '_' + i,
      patientId: patientId,
      professionalId: currentProfessionalId,
      date: date.toISOString().split('T')[0],
      time: time,
      type: typeId,
      typeName: type ? type.name : typeId,
      value: value,
      notes: 'Agendamento recorrente',
      paid: false,
      cancelled: false,
      paymentMethod: 'pix',
      isRecurrent: true
    });
  }
  
  appointments = appointments.concat(newAppointments);
  await saveDataToFirebase();
  
  closeModal('recurrenceModal');
  renderCalendar();
  alert(weeks + ' agendamentos criados com sucesso!');
}

function sendAppointmentWhatsApp() {
  if (!currentApptId) return;
  const appt = appointments.find(a => a.id === currentApptId);
  const patient = patients.find(p => p.id === appt.patientId);
  const sig = getProfessionalSignature();
  
  let msg = 'Ol√° ' + patient.name + ', tudo bem? üòä\n\nConfirma√ß√£o de agendamento:\n\nüìÖ Data: ' + formatDate(appt.date) + '\n‚è∞ Hor√°rio: ' + appt.time + '\nüè• Local: ' + sig.clinic + '\nüí∞ Valor: R$ ' + parseFloat(appt.value).toFixed(2) + '\n';
  
  if (sig.pix) msg += '\nüí≥ Chave Pix: ' + sig.pix;
  msg += '\n\nEstamos te aguardando!' + (sig.name ? '\nAtenciosamente, ' + sig.name : '') + (sig.registry ? '\n' + sig.registry : '');
  
  window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
}

function loadPatientSelect() {
  const select = document.getElementById('apptPatient');
  if (!select) return;
  
  select.innerHTML = '<option value="">Selecione...</option>';
  patients.sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name;
    select.appendChild(opt);
  });
}

// PACIENTES
function renderPatients() {
  const list = document.getElementById('patientsList');
  if (!list) return;
  
  list.innerHTML = '';
  patients.forEach(p => {
    const patientAppts = appointments.filter(a => a.patientId === p.id && !a.cancelled);
    const pending = patientAppts.filter(a => !a.paid).length;
    
    const card = document.createElement('div');
    card.className = 'card';
    let html = '<h3>' + p.name + '</h3><p>üì± ' + p.phone + '</p>';
    if (p.defaultValue) html += '<p>üí∞ R$ ' + parseFloat(p.defaultValue).toFixed(2) + '</p>';
    if (pending > 0) html += '<p style="color:#e53e3e">‚ö†Ô∏è ' + pending + ' pendente(s)</p>';
    
    card.innerHTML = html;
    card.onclick = () => openPatientModal(p.id);
    list.appendChild(card);
  });
}

function searchPatients(term) {
  document.querySelectorAll('#patientsList .card').forEach(card => {
    card.style.display = card.querySelector('h3').textContent.toLowerCase().includes(term.toLowerCase()) ? 'block' : 'none';
  });
}

function openPatientModal(patientId) {
  currentPatientId = patientId;
  selectedSessions.clear();
  
  document.getElementById('patientId').value = '';
  document.getElementById('patientName').value = '';
  document.getElementById('patientPhone').value = '';
  document.getElementById('patientEmail').value = '';
  document.getElementById('patientValue').value = '';
  document.getElementById('patientComplaint').value = '';
  
  showPatientTab('info');
  
  if (patientId) {
    const p = patients.find(x => x.id === patientId);
    document.getElementById('patientModalTitle').textContent = 'Editar Paciente';
    document.getElementById('patientId').value = p.id;
    document.getElementById('patientName').value = p.name;
    document.getElementById('patientPhone').value = p.phone;
    document.getElementById('patientEmail').value = p.email || '';
    document.getElementById('patientValue').value = p.defaultValue || '';
    document.getElementById('patientComplaint').value = p.complaint || '';
    document.getElementById('btnDeletePatient').style.display = 'block';
    renderPatientFinance();
    renderEvolutions();
  } else {
    document.getElementById('patientModalTitle').textContent = 'Novo Paciente';
    document.getElementById('btnDeletePatient').style.display = 'none';
  }
  
  document.getElementById('patientModal').classList.add('active');
}

async function savePatient() {
  const id = document.getElementById('patientId').value;
  const data = {
    id: id || Date.now().toString(),
    name: document.getElementById('patientName').value.trim(),
    phone: document.getElementById('patientPhone').value.trim(),
    email: document.getElementById('patientEmail').value.trim(),
    defaultValue: document.getElementById('patientValue').value,
    complaint: document.getElementById('patientComplaint').value.trim()
  };
  
  if (!data.name || !data.phone) { alert('Preencha nome e telefone!'); return; }
  
  if (id) {
    const idx = patients.findIndex(p => p.id === id);
    patients[idx] = data;
  } else { 
    patients.push(data); 
  }
  
  await saveDataToFirebase();
  closeModal('patientModal');
  renderPatients();
  loadPatientSelect();
  loadRecurrenceSelect();
}

async function deletePatient() {
  if (!confirm('Tem certeza que deseja excluir este paciente e todos os seus dados?')) return;
  
  patients = patients.filter(p => p.id !== currentPatientId);
  appointments = appointments.filter(a => a.patientId !== currentPatientId);
  evolutions = evolutions.filter(e => e.patientId !== currentPatientId);
  
  await saveDataToFirebase();
  closeModal('patientModal');
  renderPatients();
  renderCalendar();
  updateFinancialSummary();
  updateDashboard();
}

function showPatientTab(tab) {
  document.querySelectorAll('.patient-tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('#patientModal .tab-content').forEach(t => t.classList.remove('active'));
  
  document.getElementById('btnTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  
  if (tab === 'financeiro') renderPatientFinance();
  if (tab === 'evolucao') renderEvolutions();
}

function renderPatientFinance() {
  const patientAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled);
  const paid = patientAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
  const pending = patientAppts.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
  
  document.getElementById('patientPaid').textContent = 'R$ ' + paid.toFixed(2);
  document.getElementById('patientPending').textContent = 'R$ ' + pending.toFixed(2);
  
  const tbody = document.getElementById('patientFinanceTable');
  tbody.innerHTML = '';
  
  patientAppts.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(appt => {
    const row = document.createElement('tr');
    row.className = 'session-row' + (selectedSessions.has(appt.id) ? ' selected' : '');
    row.onclick = (e) => { if (e.target.type !== 'checkbox') toggleSessionSelection(appt.id); };
    
    const paymentLabel = appt.paymentMethod === 'pix' ? 'Pix' : appt.paymentMethod === 'cartao' ? 'Cart√£o' : 'Dinheiro';
    
    row.innerHTML = `
      <td><input type="checkbox" class="session-checkbox" ${selectedSessions.has(appt.id) ? 'checked' : ''} onchange="toggleSessionSelection('${appt.id}')"></td>
      <td>${formatDate(appt.date)}</td>
      <td>${appt.typeName || appt.type}</td>
      <td>R$ ${parseFloat(appt.value || 0).toFixed(2)}</td>
      <td>${paymentLabel}</td>
      <td>${appt.paid ? 'Pago' : 'Pendente'}</td>
      <td><button class="btn btn-primary" onclick="togglePayment('${appt.id}')">${appt.paid ? 'Desmarcar' : 'Pagar'}</button></td>
    `;
    tbody.appendChild(row);
  });
}

function toggleSessionSelection(apptId) {
  if (selectedSessions.has(apptId)) selectedSessions.delete(apptId);
  else selectedSessions.add(apptId);
  renderPatientFinance();
}

function toggleAllSessions() {
  const patientAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled && !a.paid);
  const allSelected = patientAppts.every(a => selectedSessions.has(a.id));
  patientAppts.forEach(a => allSelected ? selectedSessions.delete(a.id) : selectedSessions.add(a.id));
  renderPatientFinance();
}

function sendPendingSessionsWhatsApp() {
  if (selectedSessions.size === 0) { alert('Selecione pelo menos uma sess√£o!'); return; }
  
  const patient = patients.find(p => p.id === currentPatientId);
  const sig = getProfessionalSignature();
  
  let total = 0, sessionsList = '';
  const selectedAppts = appointments.filter(a => selectedSessions.has(a.id)).sort((a, b) => new Date(a.date) - new Date(b.date));
  
  selectedAppts.forEach((appt, index) => {
    total += parseFloat(appt.value || 0);
    sessionsList += (index + 1) + '. ' + formatDate(appt.date) + ' - R$ ' + parseFloat(appt.value || 0).toFixed(2) + '\n';
  });
  
  let msg = 'Ol√° ' + patient.name + ', tudo bem? üòä\n\nAtendimentos em aberto:\n\n' + sessionsList + '\nüí∞ *Total: R$ ' + total.toFixed(2) + '*\n\n';
  if (sig.pix) msg += 'üí≥ Chave Pix:\n*' + sig.pix + '*\n\n';
  msg += 'Qualquer d√∫vida, estou √† disposi√ß√£o!' + (sig.name ? '\n\nAtenciosamente,\n' + sig.name : '') + (sig.registry ? '\n' + sig.registry : '');
  
  window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
}

function renderEvolutions() {
  const list = document.getElementById('evolutionsList');
  if (!list) return;
  
  list.innerHTML = '';
  evolutions.filter(e => e.patientId === currentPatientId).sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time)).forEach(evo => {
    const div = document.createElement('div');
    div.style.cssText = 'background:#f7fafc;padding:15px;margin-bottom:10px;border-radius:8px;border-left:4px solid #1e3a5f';
    div.innerHTML = '<small style="color:#718096">' + formatDate(evo.date) + ' √†s ' + evo.time + '</small><p style="margin-top:5px">' + evo.text + '</p>';
    list.appendChild(div);
  });
}

async function addEvolution() {
  const text = document.getElementById('newEvolution').value;
  if (!text.trim()) return;
  
  const now = new Date();
  evolutions.push({
    id: Date.now().toString(),
    patientId: currentPatientId,
    date: now.toISOString().split('T')[0],
    time: now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
    text: text
  });
  
  await saveDataToFirebase();
  document.getElementById('newEvolution').value = '';
  renderEvolutions();
}

function generatePatientReport() {
  const month = document.getElementById('reportMonthPatient').value;
  if (!month) { alert('Selecione o m√™s!'); return; }
  
  const sig = getProfessionalSignature();
  const [year, mon] = month.split('-').map(Number);
  const patient = patients.find(p => p.id === currentPatientId);
  const monthEvos = evolutions.filter(e => e.patientId === currentPatientId && e.date.startsWith(month)).sort((a, b) => new Date(a.date) - new Date(b.date));
  const monthAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled && a.date.startsWith(month));
  const monthName = new Date(year, mon - 1).toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
  
  let report = 'RELAT√ìRIO MENSAL - ' + sig.clinic.toUpperCase() + '\n';
  report += (sig.name ? sig.name + '\n' : '');
  report += (sig.registry ? sig.registry + '\n' : '');
  report += '================================\n\n';
  report += 'Paciente: ' + patient.name + '\n';
  report += 'Per√≠odo: ' + monthName + '\n\n';
  report += 'üìã RESUMO\n';
  report += 'Atendimentos: ' + monthAppts.length + '\n\n';
  
  if (monthAppts.length > 0) {
    report += 'Datas:\n';
    monthAppts.forEach(a => { report += '‚Ä¢ ' + formatDate(a.date) + ' - ' + a.time + '\n'; });
    report += '\n';
  }
  
  report += 'üìä EVOLU√á√ÉO / ANOTA√á√ïES\n\n';
  if (monthEvos.length === 0) { report += 'Nenhuma evolu√ß√£o registrada.\n'; }
  else {
    monthEvos.forEach((evo, i) => {
      report += 'Atendimento ' + (i + 1) + ' - ' + formatDate(evo.date) + '\n';
      report += evo.text + '\n';
      report += '--------------------------------\n\n';
    });
  }
  
  report += '\n' + sig.clinic + (sig.name ? '\n' + sig.name : '') + (sig.registry ? '\n' + sig.registry : '');
  currentReport = report;
  document.getElementById('reportContent').textContent = report;
  document.getElementById('reportContainer').style.display = 'block';
}

function copyReport() {
  navigator.clipboard.writeText(currentReport).then(() => alert('Relat√≥rio copiado!'));
}

function sendReportWhatsApp() {
  const patient = patients.find(p => p.id === currentPatientId);
  window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(currentReport), '_blank');
}

function generatePDFReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const sig = getProfessionalSignature();
  const patient = patients.find(p => p.id === currentPatientId);
  const month = document.getElementById('reportMonthPatient').value;
  const [year, mon] = month.split('-').map(Number);
  const monthName = new Date(year, mon - 1).toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
  const monthEvos = evolutions.filter(e => e.patientId === currentPatientId && e.date.startsWith(month)).sort((a, b) => new Date(a.date) - new Date(b.date));
  const monthAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled && a.date.startsWith(month));
  
  doc.setFillColor(30, 58, 95);
  doc.rect(0, 0, 210, 40, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(20);
  doc.text(sig.clinic.toUpperCase(), 105, 20, { align: 'center' });
  doc.setFontSize(12);
  doc.text(sig.name || 'Profissional', 105, 30, { align: 'center' });
  doc.text(sig.registry || '', 105, 37, { align: 'center' });
  
  doc.setDrawColor(30, 58, 95);
  doc.setLineWidth(0.5);
  doc.line(10, 45, 200, 45);
  doc.setTextColor(30, 58, 95);
  doc.setFontSize(16);
  doc.text('RELAT√ìRIO MENSAL', 105, 55, { align: 'center' });
  doc.setFontSize(11);
  doc.setTextColor(0, 0, 0);
  doc.text('Paciente: ' + patient.name, 10, 70);
  doc.text('Per√≠odo: ' + monthName, 10, 78);
  doc.line(10, 85, 200, 85);
  
  let yPosition = 95;
  
  doc.setFontSize(12);
  doc.setTextColor(30, 58, 95);
  doc.text('RESUMO DO PER√çODO', 10, yPosition);
  yPosition += 10;
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(10);
  doc.text('Total de Atendimentos: ' + monthAppts.length, 10, yPosition);
  yPosition += 8;
  
  if (monthAppts.length > 0) {
    doc.text('Datas:', 10, yPosition);
    yPosition += 6;
    monthAppts.forEach(a => {
      doc.text('‚Ä¢ ' + formatDate(a.date) + ' √†s ' + a.time, 15, yPosition);
      yPosition += 5;
    });
    yPosition += 5;
  }
  
  if (yPosition > 250) { doc.addPage(); yPosition = 20; }
  
  doc.setFontSize(12);
  doc.setTextColor(30, 58, 95);
  doc.text('EVOLU√á√ÉO CL√çNICA', 10, yPosition);
  yPosition += 10;
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(10);
  
  if (monthEvos.length === 0) {
    doc.text('Nenhuma evolu√ß√£o registrada neste per√≠odo.', 10, yPosition);
    yPosition += 10;
  } else {
    monthEvos.forEach((evo, i) => {
      if (yPosition > 270) { doc.addPage(); yPosition = 20; }
      doc.setFont(undefined, 'bold');
      doc.text('Atendimento ' + (i + 1) + ' - ' + formatDate(evo.date), 10, yPosition);
      yPosition += 6;
      doc.setFont(undefined, 'normal');
      const splitText = doc.splitTextToSize(evo.text, 180);
      doc.text(splitText, 10, yPosition);
      yPosition += (splitText.length * 5) + 8;
      doc.setDrawColor(200, 200, 200);
      doc.line(10, yPosition, 200, yPosition);
      yPosition += 8;
    });
  }
  
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    doc.text('Documento gerado em ' + new Date().toLocaleDateString('pt-BR') + ' - ASM Gest√£o Cl√≠nica', 105, 290, { align: 'center' });
    doc.text('¬© 2024 Dra. Andresa Augusto - Proibida reprodu√ß√£o sem autoriza√ß√£o', 105, 295, { align: 'center' });
  }
  
  doc.save('Relatorio_' + patient.name.replace(/\s+/g, '_') + '_' + month + '.pdf');
}

// FINANCEIRO
function renderFinancialTable() {
  const tbody = document.getElementById('financialTable');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  const pendingAppts = appointments.filter(a => !a.cancelled && !a.paid).sort((a, b) => new Date(b.date) - new Date(a.date));
  
  pendingAppts.forEach(appt => {
    const patient = patients.find(p => p.id === appt.patientId);
    const row = document.createElement('tr');
    row.className = 'financial-row' + (selectedFinancial.has(appt.id) ? ' selected' : '');
    row.onclick = (e) => { if (e.target.type !== 'checkbox') toggleFinancialSelection(appt.id); };
    
    const paymentLabel = appt.paymentMethod === 'pix' ? 'Pix' : appt.paymentMethod === 'cartao' ? 'Cart√£o' : 'Dinheiro';
    
    row.innerHTML = `
      <td><input type="checkbox" class="session-checkbox" ${selectedFinancial.has(appt.id) ? 'checked' : ''} onchange="toggleFinancialSelection('${appt.id}')"></td>
      <td>${patient ? patient.name : '-'}</td>
      <td>${formatDate(appt.date)}</td>
      <td>${appt.typeName || appt.type}</td>
      <td>R$ ${parseFloat(appt.value || 0).toFixed(2)}</td>
      <td>${paymentLabel}</td>
      <td>‚è≥ Pendente</td>
      <td><button class="btn btn-primary" onclick="event.stopPropagation();togglePayment('${appt.id}')">Pagar</button></td>
    `;
    tbody.appendChild(row);
  });
  
  const count = selectedFinancial.size;
  document.getElementById('selectedCount').textContent = count;
  document.getElementById('btnCobrarSelecionados').style.display = count > 0 ? 'inline-block' : 'none';
}

function toggleFinancialSelection(apptId) {
  if (selectedFinancial.has(apptId)) selectedFinancial.delete(apptId);
  else selectedFinancial.add(apptId);
  renderFinancialTable();
}

function toggleAllFinancial() {
  const pendingAppts = appointments.filter(a => !a.cancelled && !a.paid);
  const allSelected = pendingAppts.every(a => selectedFinancial.has(a.id));
  pendingAppts.forEach(a => allSelected ? selectedFinancial.delete(a.id) : selectedFinancial.add(a.id));
  renderFinancialTable();
}

function selectAllPending() {
  const pendingAppts = appointments.filter(a => !a.cancelled && !a.paid);
  pendingAppts.forEach(a => selectedFinancial.add(a.id));
  renderFinancialTable();
}

function clearSelection() {
  selectedFinancial.clear();
  renderFinancialTable();
  document.getElementById('selectAllFinancial').checked = false;
}

function sendSelectedPendingWhatsApp() {
  if (selectedFinancial.size === 0) { alert('Selecione pelo menos um atendimento!'); return; }
  
  const byPatient = {};
  let totalGeral = 0;
  
  selectedFinancial.forEach(apptId => {
    const appt = appointments.find(a => a.id === apptId);
    const patient = patients.find(p => p.id === appt.patientId);
    if (!byPatient[appt.patientId]) { byPatient[appt.patientId] = {patient: patient, appts: [], total: 0}; }
    byPatient[appt.patientId].appts.push(appt);
    byPatient[appt.patientId].total += parseFloat(appt.value || 0);
    totalGeral += parseFloat(appt.value || 0);
  });
  
  const sig = getProfessionalSignature();
  
  if (Object.keys(byPatient).length === 1) {
    const pid = Object.keys(byPatient)[0];
    const data = byPatient[pid];
    
    let msg = 'Ol√° ' + data.patient.name + ', tudo bem? üòä\n\nGostaria de lembrar que voc√™ possui os seguintes atendimentos em aberto:\n\n';
    data.appts.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach((appt, idx) => {
      msg += (idx + 1) + '. ' + formatDate(appt.date) + ' - ' + (appt.typeName || appt.type) + ' - R$ ' + parseFloat(appt.value || 0).toFixed(2) + '\n';
    });
    msg += '\nüí∞ *Total: R$ ' + data.total.toFixed(2) + '*\n\n';
    if (sig.pix) msg += 'üí≥ Chave Pix para pagamento:\n*' + sig.pix + '*\n\n';
    msg += 'Agrade√ßo a aten√ß√£o! Qualquer d√∫vida, estou √† disposi√ß√£o.' + (sig.name ? '\n\nAtenciosamente,\n' + sig.name : '') + (sig.registry ? '\n' + sig.registry : '');
    
    window.open('https://wa.me/55' + data.patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
  } else {
    let msgConfirm = 'Voc√™ selecionou atendimentos de ' + Object.keys(byPatient).length + ' pacientes diferentes:\n\n';
    Object.values(byPatient).forEach((data, idx) => {
      msgConfirm += (idx + 1) + '. ' + data.patient.name + ' - R$ ' + data.total.toFixed(2) + '\n';
    });
    msgConfirm += '\nDeseja enviar mensagem para todos? Ser√° aberta uma janela para cada paciente.';
    
    if (confirm(msgConfirm)) {
      Object.values(byPatient).forEach(data => {
        let msg = 'Ol√° ' + data.patient.name + ', tudo bem? üòä\n\nGostaria de lembrar que voc√™ possui os seguintes atendimentos em aberto:\n\n';
        data.appts.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach((appt, idx) => {
          msg += (idx + 1) + '. ' + formatDate(appt.date) + ' - ' + (appt.typeName || appt.type) + ' - R$ ' + parseFloat(appt.value || 0).toFixed(2) + '\n';
        });
        msg += '\nüí∞ *Total: R$ ' + data.total.toFixed(2) + '*\n\n';
        if (sig.pix) msg += 'üí≥ Chave Pix para pagamento:\n*' + sig.pix + '*\n\n';
        msg += 'Agrade√ßo a aten√ß√£o! Qualquer d√∫vida, estou √† disposi√ß√£o.' + (sig.name ? '\n\nAtenciosamente,\n' + sig.name : '') + (sig.registry ? '\n' + sig.registry : '');
        
        setTimeout(() => {
          window.open('https://wa.me/55' + data.patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
        }, 500);
      });
    }
  }
}

async function togglePayment(id) {
  const appt = appointments.find(a => a.id === id);
  appt.paid = !appt.paid;
  await saveDataToFirebase();
  renderFinancialTable();
  updateFinancialSummary();
  renderCalendar();
  if (currentPatientId) renderPatientFinance();
  updateDashboard();
}

function updateFinancialSummary() {
  const activeAppts = appointments.filter(a => !a.cancelled);
  const received = activeAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
  const pending = activeAppts.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
  
  document.getElementById('totalReceived').textContent = 'R$ ' + received.toFixed(2);
  document.getElementById('totalPending').textContent = 'R$ ' + pending.toFixed(2);
  document.getElementById('totalSessions').textContent = activeAppts.length;
}

// FLUXO DE CAIXA
function showCashFlowTab(tab) {
  document.querySelectorAll('#fluxo .tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('#fluxo .tab-content').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('cf' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Tab').classList.add('active');
}

function renderCashFlow() {
  const month = document.getElementById('cashFlowMonth').value;
  if (!month) return;
  
  const entries = appointments.filter(a => !a.cancelled && a.paid && a.date.startsWith(month));
  const monthExpenses = expenses.filter(e => e.date.startsWith(month));
  
  const totalEntries = entries.reduce((s, a) => s + parseFloat(a.value || 0), 0);
  const totalExits = monthExpenses.reduce((s, e) => s + parseFloat(e.value || 0), 0);
  
  document.getElementById('cfEntries').textContent = 'R$ ' + totalEntries.toFixed(2);
  document.getElementById('cfExits').textContent = 'R$ ' + totalExits.toFixed(2);
  document.getElementById('cfBalance').textContent = 'R$ ' + (totalEntries - totalExits).toFixed(2);
  
  const entriesBody = document.getElementById('entriesTable');
  entriesBody.innerHTML = '';
  entries.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(appt => {
    const patient = patients.find(p => p.id === appt.patientId);
    const paymentLabel = appt.paymentMethod === 'pix' ? 'Pix' : appt.paymentMethod === 'cartao' ? 'Cart√£o' : 'Dinheiro';
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${formatDate(appt.date)}</td>
      <td>${patient ? patient.name : '-'}</td>
      <td>${appt.typeName || appt.type}</td>
      <td>R$ ${parseFloat(appt.value || 0).toFixed(2)}</td>
      <td>${paymentLabel}</td>
    `;
    entriesBody.appendChild(row);
  });
  
  const exitsBody = document.getElementById('exitsTable');
  exitsBody.innerHTML = '';
  monthExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(exp => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${formatDate(exp.date)}</td>
      <td>${exp.description}</td>
      <td>${exp.category}</td>
      <td>R$ ${parseFloat(exp.value || 0).toFixed(2)}</td>
      <td><button class="btn btn-danger" onclick="deleteExpense('${exp.id}')">üóë</button></td>
    `;
    exitsBody.appendChild(row);
  });
  
  if (!document.getElementById('cfEntriesTab').classList.contains('active') && !document.getElementById('cfExitsTab').classList.contains('active')) {
    showCashFlowTab('entries');
  }
}

async function deleteExpense(id) {
  if (!confirm('Excluir despesa?')) return;
  expenses = expenses.filter(e => e.id !== id);
  await saveDataToFirebase();
  renderCashFlow();
}

function openExpenseModal() {
  document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('expenseDesc').value = '';
  document.getElementById('expenseValue').value = '';
  document.getElementById('expenseModal').classList.add('active');
}

async function saveExpense() {
  const data = {
    id: Date.now().toString(),
    date: document.getElementById('expenseDate').value,
    description: document.getElementById('expenseDesc').value,
    category: document.getElementById('expenseCategory').value,
    value: parseFloat(document.getElementById('expenseValue').value) || 0
  };
  
  if (!data.date || !data.description || !data.value) { alert('Preencha todos os campos!'); return; }
  
  expenses.push(data);
  await saveDataToFirebase();
  closeModal('expenseModal');
  renderCashFlow();
}

// RELAT√ìRIOS
function renderReports() {
  const month = document.getElementById('reportMonth').value;
  if (!month) return;
  
  const monthAppts = appointments.filter(a => !a.cancelled && a.date.startsWith(month));
  const totalRevenue = monthAppts.reduce((s, a) => s + parseFloat(a.value || 0), 0);
  
  document.getElementById('reportSessions').textContent = monthAppts.length;
  document.getElementById('reportRevenue').textContent = 'R$ ' + totalRevenue.toFixed(2);
  
  const reportBody = document.getElementById('reportTable');
  reportBody.innerHTML = '';
  
  const patientStats = {};
  monthAppts.forEach(appt => {
    if (!patientStats[appt.patientId]) { patientStats[appt.patientId] = {sessions: 0, total: 0}; }
    patientStats[appt.patientId].sessions++;
    patientStats[appt.patientId].total += parseFloat(appt.value || 0);
  });
  
  Object.entries(patientStats).sort((a, b) => b[1].sessions - a[1].sessions).forEach(([patientId, stats]) => {
    const patient = patients.find(p => p.id === patientId);
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${patient ? patient.name : 'Paciente removido'}</td>
      <td>${stats.sessions}</td>
      <td>R$ ${stats.total.toFixed(2)}</td>
    `;
    reportBody.appendChild(row);
  });
}

// PDFs
function generateDashboardPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const sig = getProfessionalSignature();
  const now = new Date();
  
  doc.setFillColor(30, 58, 95);
  doc.rect(0, 0, 210, 50, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(22);
  doc.text('DASHBOARD', 105, 20, { align: 'center' });
  doc.setFontSize(14);
  doc.text(sig.clinic.toUpperCase(), 105, 32, { align: 'center' });
  doc.setFontSize(11);
  doc.text(sig.name + ' - ' + sig.registry, 105, 42, { align: 'center' });
  
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(12);
  doc.text('Per√≠odo: ' + now.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'}).toUpperCase(), 105, 60, { align: 'center' });
  
  const received = document.getElementById('dashTotalRevenue').textContent;
  const sessions = document.getElementById('dashTotalSessions').textContent;
  const ticket = document.getElementById('dashAvgTicket').textContent;
  const pending = document.getElementById('dashPending').textContent;
  
  let y = 80;
  doc.setFillColor(56, 161, 105);
  doc.rect(10, y, 90, 30, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(10);
  doc.text('FATURAMENTO TOTAL', 15, y + 10);
  doc.setFontSize(16);
  doc.text(received, 15, y + 25);
  
  doc.setFillColor(30, 58, 95);
  doc.rect(110, y, 90, 30, 'F');
  doc.setFontSize(10);
  doc.text('ATENDIMENTOS', 115, y + 10);
  doc.setFontSize(16);
  doc.text(sessions, 115, y + 25);
  
  y += 40;
  doc.setFillColor(128, 90, 213);
  doc.rect(10, y, 90, 30, 'F');
  doc.setFontSize(10);
  doc.text('TICKET M√âDIO', 15, y + 10);
  doc.setFontSize(16);
  doc.text(ticket, 15, y + 25);
  
  doc.setFillColor(229, 62, 62);
  doc.rect(110, y, 90, 30, 'F');
  doc.setFontSize(10);
  doc.text('A RECEBER', 115, y + 10);
  doc.setFontSize(16);
  doc.text(pending, 115, y + 25);
  
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.text('Documento gerado em ' + now.toLocaleDateString('pt-BR') + ' - ASM Gest√£o Cl√≠nica', 105, 290, { align: 'center' });
  doc.text('¬© 2024 Dra. Andresa Augusto - Proibida reprodu√ß√£o sem autoriza√ß√£o', 105, 295, { align: 'center' });
  
  doc.save('Dashboard_' + now.toISOString().slice(0, 7) + '.pdf');
}

function generateMonthlyReportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const sig = getProfessionalSignature();
  const month = document.getElementById('reportMonth').value;
  if (!month) { alert('Selecione o m√™s!'); return; }
  
  const [year, mon] = month.split('-').map(Number);
  const monthName = new Date(year, mon - 1).toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
  const monthAppts = appointments.filter(a => !a.cancelled && a.date.startsWith(month));
  const totalRevenue = monthAppts.reduce((s, a) => s + parseFloat(a.value || 0), 0);
  
  doc.setFillColor(30, 58, 95);
  doc.rect(0, 0, 210, 50, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(22);
  doc.text('RELAT√ìRIO MENSAL', 105, 20, { align: 'center' });
  doc.setFontSize(14);
  doc.text(sig.clinic.toUpperCase(), 105, 32, { align: 'center' });
  doc.setFontSize(11);
  doc.text(sig.name + ' - ' + sig.registry, 105, 42, { align: 'center' });
  
  doc.setDrawColor(30, 58, 95);
  doc.setLineWidth(0.5);
  doc.line(10, 55, 200, 55);
  
  doc.setTextColor(30, 58, 95);
  doc.setFontSize(16);
  doc.text('Per√≠odo: ' + monthName.toUpperCase(), 105, 65, { align: 'center' });
  
  doc.setFontSize(12);
  doc.text('RESUMO GERAL', 10, 80);
  doc.setFontSize(11);
  doc.setTextColor(0, 0, 0);
  doc.text('Total de Atendimentos: ' + monthAppts.length, 10, 90);
  doc.text('Faturamento Total: R$ ' + totalRevenue.toFixed(2), 10, 98);
  doc.text('Ticket M√©dio: R$ ' + (monthAppts.length > 0 ? (totalRevenue / monthAppts.length).toFixed(2) : '0.00'), 10, 106);
  
  const patientStats = {};
  monthAppts.forEach(appt => {
    if (!patientStats[appt.patientId]) { patientStats[appt.patientId] = {sessions: 0, total: 0}; }
    patientStats[appt.patientId].sessions++;
    patientStats[appt.patientId].total += parseFloat(appt.value || 0);
  });
  
  const tableData = Object.entries(patientStats)
    .sort((a, b) => b[1].sessions - a[1].sessions)
    .map(([patientId, stats]) => {
      const patient = patients.find(p => p.id === patientId);
      return [(patient ? patient.name : 'Paciente removido'), stats.sessions.toString(), 'R$ ' + stats.total.toFixed(2)];
    });
  
  doc.autoTable({
    startY: 120,
    head: [['Paciente', 'Sess√µes', 'Total']],
    body: tableData,
    theme: 'striped',
    headStyles: { fillColor: [30, 58, 95], textColor: 255 },
    styles: { fontSize: 10, cellPadding: 5 },
    columnStyles: { 0: { cellWidth: 100 }, 1: { cellWidth: 30, halign: 'center' }, 2: { cellWidth: 40, halign: 'right' } }
  });
  
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    doc.text('Documento gerado em ' + new Date().toLocaleDateString('pt-BR') + ' - ASM Gest√£o Cl√≠nica', 105, 290, { align: 'center' });
    doc.text('¬© 2024 Dra. Andresa Augusto - Proibida reprodu√ß√£o sem autoriza√ß√£o', 105, 295, { align: 'center' });
  }
  
  doc.save('Relatorio_Mensal_' + month + '.pdf');
}

// UTILIT√ÅRIOS
function closeModal(id) { 
  document.getElementById(id).classList.remove('active'); 
}

function formatDate(dateStr) {
  const parts = dateStr.split('-');
  return parts[2] + '/' + parts[1] + '/' + parts[0];
}

document.addEventListener('click', function(e) { 
  if (e.target.classList.contains('modal')) { 
    e.target.classList.remove('active'); 
  } 
});

// Sincroniza√ß√£o peri√≥dica
setInterval(() => {
  if (currentActivationCode && !isAdmin && document.getElementById('mainSystem').style.display !== 'none') {
    database.ref(userDataPath).once('value').then(snapshot => {
      const data = snapshot.val() || {};
      appointments = data.appointments || appointments;
      patients = data.patients || patients;
      expenses = data.expenses || expenses;
      renderCalendar();
    });
  }
}, 30000);

console.log('ASM Gest√£o Cl√≠nica - Sistema carregado com sucesso!');
console.log('Vers√£o: 2.0 Multicl√≠nica + Dashboard');
</script>
</body>
</html>
