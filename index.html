<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASM Gest√£o Cl√≠nica PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --navy: #1a237e;
            --navy-light: #283593;
            --gold: #ffd700;
            --gold-dark: #ffb300;
            --light-gray: #f5f5f5;
            --white: #ffffff;
            --success: #4caf50;
            --danger: #f44336;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--navy) 0%, #0d1642 100%);
            min-height: 100vh;
            color: #333;
        }
        
        /* Telas de Autentica√ß√£o */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-box {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 3px solid var(--gold);
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-logo h1 {
            color: var(--navy);
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .auth-logo p {
            color: var(--gold-dark);
            font-weight: bold;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--navy);
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--navy);
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: var(--white);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(26, 35, 126, 0.4);
        }
        
        .btn-gold {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--navy);
        }
        
        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }
        
        .auth-links {
            text-align: center;
            margin-top: 20px;
        }
        
        .auth-links a {
            color: var(--navy);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        .auth-links a:hover {
            text-decoration: underline;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        
        .alert-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #2196f3;
        }
        
        .hidden { display: none !important; }
        
        /* C√≥digo de Ativa√ß√£o */
        .activation-code-box {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: var(--gold);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            border: 3px solid var(--gold);
        }
        
        .activation-code {
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 5px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        
        .activation-instructions {
            background: #fff8e1;
            border-left: 4px solid var(--gold);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        /* Sistema Principal */
        .app-container {
            display: none;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: var(--white);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-icon {
            background: rgba(255,255,255,0.2);
            border: none;
            color: var(--white);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .btn-icon:hover {
            background: var(--gold);
            color: var(--navy);
        }
        
        .main-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Menu */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .menu-item {
            background: var(--white);
            border-radius: 15px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .menu-item:hover {
            transform: translateY(-5px);
            border-color: var(--gold);
            box-shadow: 0 10px 30px rgba(26, 35, 126, 0.2);
        }
        
        .menu-item i {
            font-size: 32px;
            color: var(--navy);
            margin-bottom: 10px;
            display: block;
        }
        
        .menu-item span {
            font-weight: 600;
            color: var(--navy);
            font-size: 14px;
        }
        
        /* Cards */
        .card {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }
        
        .card-title {
            color: var(--navy);
            font-size: 20px;
            font-weight: bold;
        }
        
        /* Tabelas */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: var(--navy);
            color: var(--white);
            font-weight: 600;
            font-size: 14px;
        }
        
        tr:hover {
            background: var(--light-gray);
        }
        
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .badge-warning {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .badge-danger {
            background: #ffebee;
            color: #c62828;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--white);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: var(--white);
            padding: 25px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--white);
            font-size: 28px;
            cursor: pointer;
        }
        
        /* Abas */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light-gray);
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: var(--navy);
            border-bottom-color: var(--gold);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Formul√°rios */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        /* Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: var(--white);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid var(--gold);
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: var(--gold);
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Bot√µes de a√ß√£o */
        .action-btns {
            display: flex;
            gap: 10px;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-edit {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .btn-delete {
            background: #ffebee;
            color: #c62828;
        }
        
        .btn-view {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        /* Responsivo */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .auth-box {
                padding: 25px;
            }
            
            .header h1 {
                font-size: 16px;
            }
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Footer copyright */
        .copyright {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #e0e0e0;
            margin-top: 40px;
        }
        
        .copyright strong {
            color: var(--navy);
        }
        
        /* Calend√°rio simples */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 20px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
        }
        
        .calendar-day:hover {
            background: var(--light-gray);
        }
        
        .calendar-day.has-event {
            background: var(--navy);
            color: var(--white);
        }
        
        .calendar-day.selected {
            background: var(--gold);
            color: var(--navy);
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
            color: var(--navy);
        }
        
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav button {
            background: var(--navy);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Timeline de evolu√ß√£o */
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--navy);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            background: var(--light-gray);
            padding: 20px;
            border-radius: 10px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 24px;
            width: 12px;
            height: 12px;
            background: var(--gold);
            border-radius: 50%;
            border: 2px solid var(--navy);
        }
        
        .timeline-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .timeline-content {
            color: #333;
        }
        
        /* Anima√ß√µes */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* √çcones simples */
        .icon::before {
            display: inline-block;
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
        }
        
        .icon-calendar::before { content: "üìÖ"; }
        .icon-users::before { content: "üë•"; }
        .icon-dollar::before { content: "üí∞"; }
        .icon-chart::before { content: "üìä"; }
        .icon-file::before { content: "üìÑ"; }
        .icon-settings::before { content: "‚öôÔ∏è"; }
        .icon-logout::before { content: "üö™"; }
        .icon-plus::before { content: "‚ûï"; }
        .icon-search::before { content: "üîç"; }
        .icon-whatsapp::before { content: "üí¨"; }
        .icon-pdf::before { content: "üìë"; }
    </style>
</head>
<body>

    <!-- TELA DE LOGIN -->
    <div id="loginScreen" class="auth-container">
        <div class="auth-box">
            <div class="auth-logo">
                <h1>üè• ASM Gest√£o Cl√≠nica</h1>
                <p>Sistema Profissional de Gest√£o</p>
            </div>
            
            <div id="loginAlert"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="loginEmail" required placeholder="seu@email.com">
                </div>
                
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span id="loginBtnText">Entrar</span>
                </button>
            </form>
            
            <div class="auth-links">
                <p>N√£o tem conta? <a onclick="showScreen('registerScreen')">Cadastre-se</a></p>
                <p style="margin-top: 10px;"><a onclick="showScreen('forgotScreen')">Esqueci minha senha</a></p>
            </div>
            
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                <p style="font-size: 12px; color: #666;">
                    <strong>CREFITO:</strong> 40.9314-F<br>
                    Dra Andresa Augusto
                </p>
            </div>
        </div>
    </div>

    <!-- TELA DE CADASTRO -->
    <div id="registerScreen" class="auth-container hidden">
        <div class="auth-box">
            <div class="auth-logo">
                <h1>üìù Criar Conta</h1>
                <p>Comece sua gest√£o profissional</p>
            </div>
            
            <div id="registerAlert"></div>
            
            <form id="registerForm">
                <div class="form-group">
                    <label>Nome Completo</label>
                    <input type="text" id="regName" required placeholder="Seu nome completo">
                </div>
                
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="regEmail" required placeholder="seu@email.com">
                </div>
                
                <div class="form-group">
                    <label>CPF</label>
                    <input type="text" id="regCpf" required placeholder="000.000.000-00" maxlength="14">
                </div>
                
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="regPassword" required placeholder="M√≠nimo 6 caracteres" minlength="6">
                </div>
                
                <div class="form-group">
                    <label>Confirmar Senha</label>
                    <input type="password" id="regPasswordConfirm" required placeholder="Repita a senha">
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span id="regBtnText">Criar Conta</span>
                </button>
            </form>
            
            <div class="auth-links">
                <p>J√° tem conta? <a onclick="showScreen('loginScreen')">Fa√ßa login</a></p>
            </div>
        </div>
    </div>

    <!-- TELA DE CONFIRMA√á√ÉO DE E-MAIL -->
    <div id="confirmScreen" class="auth-container hidden">
        <div class="auth-box">
            <div class="auth-logo">
                <h1>‚úâÔ∏è Confirme seu E-mail</h1>
                <p>Quase l√°!</p>
            </div>
            
            <div class="alert alert-info">
                <strong>Enviamos um link de confirma√ß√£o para:</strong><br>
                <span id="confirmEmail" style="font-size: 18px; color: var(--navy);"></span>
            </div>
            
            <div class="activation-instructions">
                <strong>üìã Passo a passo:</strong><br>
                1. Acesse seu e-mail<br>
                2. Clique no link de confirma√ß√£o<br>
                3. Volte aqui e clique em "J√° confirmei"
            </div>
            
            <button onclick="checkEmailConfirmed()" class="btn btn-primary">
                ‚úÖ J√° confirmei meu e-mail
            </button>
            
            <button onclick="resendConfirmation()" class="btn btn-gold" style="margin-top: 10px;">
                üîÑ Reenviar e-mail
            </button>
            
            <div class="auth-links">
                <p><a onclick="showScreen('loginScreen')">Voltar para login</a></p>
            </div>
        </div>
    </div>

    <!-- TELA DE ATIVA√á√ÉO -->
    <div id="activationScreen" class="auth-container hidden">
        <div class="auth-box">
            <div class="auth-logo">
                <h1>üéâ E-mail Confirmado!</h1>
                <p>Ative seu sistema agora</p>
            </div>
            
            <div id="activationAlert"></div>
            
            <div class="activation-code-box" id="generatedCodeBox" style="display: none;">
                <div>Seu C√≥digo de Ativa√ß√£o:</div>
                <div class="activation-code" id="generatedCode"></div>
                <div style="font-size: 12px; margin-top: 10px; opacity: 0.9;">
                    Guarde este c√≥digo! Voc√™ precisar√° dele para ativar.
                </div>
            </div>
            
            <form id="activationForm">
                <div class="form-group">
                    <label>Digite seu C√≥digo de Ativa√ß√£o</label>
                    <input type="text" id="activationCode" required placeholder="AA000000" maxlength="8" style="text-transform: uppercase; text-align: center; font-size: 24px; letter-spacing: 5px;">
                </div>
                
                <button type="submit" class="btn btn-primary">
                    üîì Ativar Sistema
                </button>
            </form>
            
            <div class="activation-instructions">
                <strong>üí° Como obter o c√≥digo?</strong><br>
                O c√≥digo √© gerado automaticamente ap√≥s a confirma√ß√£o do e-mail.<br>
                Se n√£o apareceu acima, aguarde alguns segundos ou atualize a p√°gina.
            </div>
        </div>
    </div>

    <!-- TELA DE RECUPERA√á√ÉO DE SENHA -->
    <div id="forgotScreen" class="auth-container hidden">
        <div class="auth-box">
            <div class="auth-logo">
                <h1>üîê Recuperar Senha</h1>
                <p>Enviaremos um link para seu e-mail</p>
            </div>
            
            <div id="forgotAlert"></div>
            
            <form id="forgotForm">
                <div class="form-group">
                    <label>E-mail cadastrado</label>
                    <input type="email" id="forgotEmail" required placeholder="seu@email.com">
                </div>
                
                <button type="submit" class="btn btn-primary">
                    üìß Enviar Link de Recupera√ß√£o
                </button>
            </form>
            
            <div class="auth-links">
                <p><a onclick="showScreen('loginScreen')">Voltar para login</a></p>
            </div>
        </div>
    </div>

    <!-- SISTEMA PRINCIPAL -->
    <div id="appContainer" class="app-container">
        <header class="header">
            <h1>
                <span>üè•</span>
                ASM Gest√£o Cl√≠nica PRO
            </h1>
            <div class="header-actions">
                <button class="btn-icon" onclick="showProfile()" title="Perfil">üë§</button>
                <button class="btn-icon" onclick="logout()" title="Sair">üö™</button>
            </div>
        </header>

        <div class="main-content">
            <!-- MENU PRINCIPAL -->
            <div id="mainMenu" class="fade-in">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Pacientes</div>
                        <div class="stat-value" id="statPatients">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Consultas Hoje</div>
                        <div class="stat-value" id="statToday">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Receita M√™s</div>
                        <div class="stat-value" id="statRevenue">R$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pend√™ncias</div>
                        <div class="stat-value" id="statPending">0</div>
                    </div>
                </div>

                <div class="menu-grid">
                    <div class="menu-item" onclick="showSection('agenda')">
                        <i class="icon-calendar"></i>
                        <span>Agenda</span>
                    </div>
                    <div class="menu-item" onclick="showSection('pacientes')">
                        <i class="icon-users"></i>
                        <span>Pacientes</span>
                    </div>
                    <div class="menu-item" onclick="showSection('financeiro')">
                        <i class="icon-dollar"></i>
                        <span>Financeiro</span>
                    </div>
                    <div class="menu-item" onclick="showSection('relatorios')">
                        <i class="icon-chart"></i>
                        <span>Relat√≥rios</span>
                    </div>
                    <div class="menu-item" onclick="showSection('documentos')">
                        <i class="icon-file"></i>
                        <span>Documentos</span>
                    </div>
                    <div class="menu-item" onclick="showSection('config')">
                        <i class="icon-settings"></i>
                        <span>Configura√ß√µes</span>
                    </div>
                </div>

                <!-- Pr√≥ximas Consultas -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìÖ Pr√≥ximas Consultas</h2>
                        <button class="btn-sm btn-primary" onclick="openModal('appointmentModal')" style="background: var(--navy); color: white;">+ Nova</button>
                    </div>
                    <div id="upcomingAppointments">
                        <p style="text-align: center; color: #666; padding: 20px;">Nenhuma consulta agendada</p>
                    </div>
                </div>
            </div>

            <!-- SE√á√ÉO AGENDA -->
            <div id="agendaSection" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìÖ Agenda Completa</h2>
                        <button class="btn-sm btn-primary" onclick="openModal('appointmentModal')" style="background: var(--navy); color: white;">+ Novo Agendamento</button>
                    </div>
                    
                    <div class="calendar-nav">
                        <button onclick="changeMonth(-1)">‚óÄ Anterior</button>
                        <h3 id="currentMonth" style="color: var(--navy);"></h3>
                        <button onclick="changeMonth(1)">Pr√≥ximo ‚ñ∂</button>
                    </div>
                    
                    <div class="calendar-header">
                        <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìã Compromissos do Dia</h2>
                    </div>
                    <div id="dayAppointments"></div>
                </div>
            </div>

            <!-- SE√á√ÉO PACIENTES -->
            <div id="pacientesSection" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üë• Pacientes</h2>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="searchPatient" placeholder="Buscar paciente..." style="padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd;" onkeyup="searchPatients()">
                            <button class="btn-sm btn-primary" onclick="openModal('patientModal')" style="background: var(--navy); color: white;">+ Novo</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="patientsTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>√öltima Consulta</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="patientsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SE√á√ÉO FINANCEIRO -->
            <div id="financeiroSection" class="hidden">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Entradas</div>
                        <div class="stat-value" id="finIncome">R$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Sa√≠das</div>
                        <div class="stat-value" id="finExpense">R$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Saldo</div>
                        <div class="stat-value" id="finBalance">R$0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üí∞ Fluxo de Caixa</h2>
                        <button class="btn-sm btn-primary" onclick="openModal('transactionModal')" style="background: var(--navy); color: white;">+ Lan√ßamento</button>
                    </div>
                    <div class="table-container">
                        <table id="transactionsTable">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Tipo</th>
                                    <th>Valor</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SE√á√ÉO RELAT√ìRIOS -->
            <div id="relatoriosSection" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìä Relat√≥rios</h2>
                    </div>
                    
                    <div class="tabs">
                        <button class="tab active" onclick="showTab('relFinanceiro')">Financeiro</button>
                        <button class="tab" onclick="showTab('relPacientes')">Pacientes</button>
                        <button class="tab" onclick="showTab('relAgenda')">Agenda</button>
                    </div>

                    <div id="relFinanceiro" class="tab-content active">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Data Inicial</label>
                                <input type="date" id="relDateStart">
                            </div>
                            <div class="form-group">
                                <label>Data Final</label>
                                <input type="date" id="relDateEnd">
                            </div>
                        </div>
                        <button onclick="generateFinancialReport()" class="btn btn-primary" style="margin-top: 10px;">
                            üìÑ Gerar Relat√≥rio Financeiro
                        </button>
                        <div id="financialReportResult"></div>
                    </div>

                    <div id="relPacientes" class="tab-content">
                        <button onclick="generatePatientsReport()" class="btn btn-primary">
                            üìÑ Gerar Relat√≥rio de Pacientes
                        </button>
                        <div id="patientsReportResult" style="margin-top: 20px;"></div>
                    </div>

                    <div id="relAgenda" class="tab-content">
                        <div class="form-group">
                            <label>M√™s</label>
                            <input type="month" id="relAgendaMonth">
                        </div>
                        <button onclick="generateAgendaReport()" class="btn btn-primary" style="margin-top: 10px;">
                            üìÑ Gerar Relat√≥rio de Agenda
                        </button>
                        <div id="agendaReportResult"></div>
                    </div>
                </div>
            </div>

            <!-- SE√á√ÉO DOCUMENTOS -->
            <div id="documentosSection" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìÑ Documentos Cl√≠nicos</h2>
                    </div>
                    <div class="menu-grid">
                        <div class="menu-item" onclick="openDocModal('atestado')">
                            <i>üìù</i>
                            <span>Atestado M√©dico</span>
                        </div>
                        <div class="menu-item" onclick="openDocModal('receita')">
                            <i>üíä</i>
                            <span>Receitu√°rio</span>
                        </div>
                        <div class="menu-item" onclick="openDocModal('declaracao')">
                            <i>üìã</i>
                            <span>Declara√ß√£o de Comparecimento</span>
                        </div>
                        <div class="menu-item" onclick="openDocModal('encaminhamento')">
                            <i>‚û°Ô∏è</i>
                            <span>Encaminhamento</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SE√á√ÉO CONFIGURA√á√ïES -->
            <div id="configSection" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">‚öôÔ∏è Configura√ß√µes</h2>
                    </div>
                    
                    <h3 style="color: var(--navy); margin-bottom: 15px;">Dados da Cl√≠nica</h3>
                    <div class="form-group">
                        <label>Nome da Cl√≠nica</label>
                        <input type="text" id="configClinicName" value="ASM Fisioterapia">
                    </div>
                    <div class="form-group">
                        <label>Endere√ßo</label>
                        <input type="text" id="configAddress" placeholder="Endere√ßo completo">
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="text" id="configPhone" placeholder="(00) 00000-0000">
                    </div>
                    <div class="form-group">
                        <label>CREFITO</label>
                        <input type="text" id="configCrefito" value="40.9314-F" readonly style="background: #f5f5f5;">
                    </div>
                    
                    <button onclick="saveConfig()" class="btn btn-primary" style="margin-top: 20px;">
                        üíæ Salvar Configura√ß√µes
                    </button>
                </div>
            </div>

            <div class="copyright">
                <strong>ASM Gest√£o Cl√≠nica PRO</strong><br>
                Dra Andresa Augusto - CREFITO 40.9314-F<br>
                ¬© 2026 - Proibida reprodu√ß√£o sem autoriza√ß√£o
            </div>
        </div>
    </div>

    <!-- MODAL: NOVO PACIENTE -->
    <div id="patientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë§ Novo Paciente</h3>
                <button class="close-btn" onclick="closeModal('patientModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="patientForm">
                    <input type="hidden" id="patientId">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nome Completo *</label>
                            <input type="text" id="patientName" required>
                        </div>
                        <div class="form-group">
                            <label>Data de Nascimento</label>
                            <input type="date" id="patientBirth">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>CPF</label>
                            <input type="text" id="patientCpf" maxlength="14">
                        </div>
                        <div class="form-group">
                            <label>Telefone *</label>
                            <input type="text" id="patientPhone" required maxlength="15">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" id="patientEmail">
                    </div>
                    <div class="form-group">
                        <label>Endere√ßo</label>
                        <input type="text" id="patientAddress">
                    </div>
                    <div class="form-group">
                        <label>Queixa Principal</label>
                        <textarea id="patientComplaint"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Hist√≥rico M√©dico</label>
                        <textarea id="patientHistory"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Salvar</button>
                        <button type="button" class="btn" style="flex: 1; background: #f5f5f5; color: #333;" onclick="closeModal('patientModal')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: PRONTU√ÅRIO/EVOLU√á√ÉO -->
    <div id="evolutionModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>üìã Prontu√°rio do Paciente</h3>
                <button class="close-btn" onclick="closeModal('evolutionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="patientEvolutionInfo" style="margin-bottom: 20px; padding: 15px; background: var(--light-gray); border-radius: 10px;"></div>
                
                <div class="tabs">
                    <button class="tab active" onclick="showTab('evoHistory')">Hist√≥rico</button>
                    <button class="tab" onclick="showTab('evoNew')">Nova Evolu√ß√£o</button>
                    <button class="tab" onclick="showTab('evoDocs')">Documentos</button>
                </div>

                <div id="evoHistory" class="tab-content active">
                    <div class="timeline" id="evolutionTimeline"></div>
                </div>

                <div id="evoNew" class="tab-content">
                    <form id="evolutionForm">
                        <input type="hidden" id="evoPatientId">
                        <div class="form-group">
                            <label>Data da Consulta</label>
                            <input type="datetime-local" id="evoDate" required>
                        </div>
                        <div class="form-group">
                            <label>Evolu√ß√£o / Observa√ß√µes</label>
                            <textarea id="evoText" required placeholder="Descreva a evolu√ß√£o do paciente..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Conduta / Prescri√ß√£o</label>
                            <textarea id="evoConduct" placeholder="Conduta adotada..."></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Salvar Evolu√ß√£o</button>
                            <button type="button" onclick="generateEvolutionPDF()" class="btn btn-gold" style="flex: 1;">üìÑ Gerar PDF</button>
                        </div>
                    </form>
                </div>

                <div id="evoDocs" class="tab-content">
                    <div class="menu-grid">
                        <div class="menu-item" onclick="generateDoc('atestado')">
                            <i>üìù</i>
                            <span>Atestado</span>
                        </div>
                        <div class="menu-item" onclick="generateDoc('receita')">
                            <i>üíä</i>
                            <span>Receita</span>
                        </div>
                        <div class="menu-item" onclick="sendWhatsApp()">
                            <i class="icon-whatsapp"></i>
                            <span>WhatsApp</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: NOVO AGENDAMENTO -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÖ Novo Agendamento</h3>
                <button class="close-btn" onclick="closeModal('appointmentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    <div class="form-group">
                        <label>Paciente *</label>
                        <select id="appPatient" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data *</label>
                            <input type="date" id="appDate" required>
                        </div>
                        <div class="form-group">
                            <label>Hora *</label>
                            <input type="time" id="appTime" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Consulta</label>
                        <select id="appType">
                            <option value="avaliacao">Avalia√ß√£o</option>
                            <option value="sessao">Sess√£o de Fisioterapia</option>
                            <option value="retorno">Retorno</option>
                            <option value="procedimento">Procedimento</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Observa√ß√µes</label>
                        <textarea id="appNotes"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Agendar</button>
                        <button type="button" class="btn" style="flex: 1; background: #f5f5f5;" onclick="closeModal('appointmentModal')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: LAN√áAMENTO FINANCEIRO -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí∞ Novo Lan√ßamento</h3>
                <button class="close-btn" onclick="closeModal('transactionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="transactionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo *</label>
                            <select id="transType" required>
                                <option value="income">Entrada</option>
                                <option value="expense">Sa√≠da</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Valor *</label>
                            <input type="number" id="transValue" step="0.01" required placeholder="0,00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descri√ß√£o *</label>
                        <input type="text" id="transDesc" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" id="transDate" required>
                        </div>
                        <div class="form-group">
                            <label>Categoria</label>
                            <select id="transCategory">
                                <option value="consulta">Consulta</option>
                                <option value="exame">Exame</option>
                                <option value="procedimento">Procedimento</option>
                                <option value="material">Material</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Salvar</button>
                        <button type="button" class="btn" style="flex: 1; background: #f5f5f5;" onclick="closeModal('transactionModal')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: DOCUMENTOS -->
    <div id="docModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="docModalTitle">üìÑ Documento</h3>
                <button class="close-btn" onclick="closeModal('docModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="docForm">
                    <div class="form-group">
                        <label>Paciente</label>
                        <select id="docPatient" required></select>
                    </div>
                    <div id="docSpecificFields"></div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" onclick="generateDocPDF()" class="btn btn-primary" style="flex: 1;">üìÑ Gerar PDF</button>
                        <button type="button" onclick="closeModal('docModal')" class="btn" style="flex: 1; background: #f5f5f5;">Fechar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============== CONFIGURA√á√ÉO SUPABASE ==============
        // SUBSTITUA ESTES VALORES PELOS SEUS DO SUPABASE!
        const SUPABASE_URL = 'https://nycjicdhwamnivfyhhst.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55Y2ppY2Rod2Ftbml2ZnloaHN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NDkwOTAsImV4cCI6MjA4NzEyNTA5MH0.c0TZ46vwHCu4Ta1AAlMEtipyvCv3eRNV33mtaxLNL7g';
        
        let supabase;
        let currentUser = null;
        let currentPatient = null;
        let currentDate = new Date();
        
        // Inicializar Supabase
        function initSupabase() {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            checkSession();
        }
        
        // ============== NAVEGA√á√ÉO ==============
        function showScreen(screenId) {
            document.querySelectorAll('.auth-container').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }
        
        function showSection(section) {
            document.getElementById('mainMenu').classList.add('hidden');
            document.querySelectorAll('[id$="Section"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(section + 'Section').classList.remove('hidden');
            document.getElementById(section + 'Section').classList.add('fade-in');
            
            if(section === 'agenda') renderCalendar();
            if(section === 'pacientes') loadPatients();
            if(section === 'financeiro') loadTransactions();
        }
        
        function showTab(tabName) {
            event.target.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }
        
        function backToMenu() {
            document.querySelectorAll('[id$="Section"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('mainMenu').classList.add('fade-in');
            loadDashboard();
        }
        
        // ============== AUTENTICA√á√ÉO ==============
        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (profile && profile.activated) {
                    showApp();
                } else if (profile && !profile.activated) {
                    showScreen('activationScreen');
                    generateActivationCode(currentUser.id);
                }
            } else {
                showScreen('loginScreen');
            }
        }
        
        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('loginBtnText');
            btn.innerHTML = '<span class="loading"></span>';
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            
            if (error) {
                showAlert('loginAlert', error.message, 'error');
                btn.textContent = 'Entrar';
            } else {
                currentUser = data.user;
                checkActivation();
            }
        });
        
        // Cadastro
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('regBtnText');
            btn.innerHTML = '<span class="loading"></span>';
            
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const cpf = document.getElementById('regCpf').value;
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regPasswordConfirm').value;
            
            if (password !== confirm) {
                showAlert('registerAlert', 'As senhas n√£o conferem!', 'error');
                btn.textContent = 'Criar Conta';
                return;
            }
            
            // Criar usu√°rio no Auth
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: { name, cpf }
                }
            });
            
            if (error) {
                showAlert('registerAlert', error.message, 'error');
                btn.textContent = 'Criar Conta';
            } else {
                // Criar perfil
                await supabase.from('profiles').insert([{
                    id: data.user.id,
                    name,
                    email,
                    cpf,
                    activated: false,
                    created_at: new Date().toISOString()
                }]);
                
                document.getElementById('confirmEmail').textContent = email;
                showScreen('confirmScreen');
            }
        });
        
        // Verificar se e-mail foi confirmado
        async function checkEmailConfirmed() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                showScreen('activationScreen');
                generateActivationCode(currentUser.id);
            } else {
                showAlert('loginAlert', 'E-mail ainda n√£o confirmado. Verifique sua caixa de entrada.', 'error');
                showScreen('loginScreen');
            }
        }
        
        // Reenviar confirma√ß√£o
        async function resendConfirmation() {
            const email = document.getElementById('confirmEmail').textContent;
            await supabase.auth.resend({
                type: 'signup',
                email
            });
            alert('E-mail reenviado!');
        }
        
        // Gerar c√≥digo de ativa√ß√£o autom√°tico
        async function generateActivationCode(userId) {
            // Verificar se j√° existe c√≥digo
            const { data: existing } = await supabase
                .from('activation_codes')
                .select('*')
                .eq('user_id', userId)
                .single();
            
            if (existing) {
                document.getElementById('generatedCode').textContent = existing.code;
                document.getElementById('generatedCodeBox').style.display = 'block';
                return;
            }
            
            // Gerar novo c√≥digo: AA + 6 caracteres aleat√≥rios
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = 'AA';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            // Salvar c√≥digo
            await supabase.from('activation_codes').insert([{
                user_id: userId,
                code: code,
                used: false,
                created_at: new Date().toISOString()
            }]);
            
            document.getElementById('generatedCode').textContent = code;
            document.getElementById('generatedCodeBox').style.display = 'block';
        }
        
        // Ativar sistema
        document.getElementById('activationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('activationCode').value.toUpperCase();
            
            const { data, error } = await supabase
                .from('activation_codes')
                .select('*')
                .eq('code', code)
                .eq('used', false)
                .single();
            
            if (!data) {
                showAlert('activationAlert', 'C√≥digo inv√°lido ou j√° utilizado!', 'error');
                return;
            }
            
            // Ativar usu√°rio
            await supabase
                .from('profiles')
                .update({ activated: true })
                .eq('id', currentUser.id);
            
            await supabase
                .from('activation_codes')
                .update({ used: true, used_at: new Date().toISOString() })
                .eq('code', code);
            
            showApp();
        });
        
        // Recuperar senha
        document.getElementById('forgotForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin
            });
            
            if (error) {
                showAlert('forgotAlert', error.message, 'error');
            } else {
                showAlert('forgotAlert', 'Link de recupera√ß√£o enviado! Verifique seu e-mail.', 'success');
            }
        });
        
        // Logout
        async function logout() {
            await supabase.auth.signOut();
            location.reload();
        }
        
        // Verificar ativa√ß√£o
        async function checkActivation() {
            const { data: profile } = await supabase
                .from('profiles')
                .select('activated')
                .eq('id', currentUser.id)
                .single();
            
            if (profile && profile.activated) {
                showApp();
            } else {
                showScreen('activationScreen');
                generateActivationCode(currentUser.id);
            }
        }
        
        // Mostrar aplicativo
        function showApp() {
            document.querySelectorAll('.auth-container').forEach(el => el.classList.add('hidden'));
            document.getElementById('appContainer').style.display = 'block';
            loadDashboard();
            initDatabase();
        }
        
        // ============== BANCO DE DADOS ==============
        async function initDatabase() {
            // Criar tabelas se n√£o existirem (usando localStorage como fallback)
            if (!localStorage.getItem('asm_patients')) {
                localStorage.setItem('asm_patients', JSON.stringify([]));
            }
            if (!localStorage.getItem('asm_appointments')) {
                localStorage.setItem('asm_appointments', JSON.stringify([]));
            }
            if (!localStorage.getItem('asm_transactions')) {
                localStorage.setItem('asm_transactions', JSON.stringify([]));
            }
            if (!localStorage.getItem('asm_evolutions')) {
                localStorage.setItem('asm_evolutions', JSON.stringify([]));
            }
            
            // Tentar sincronizar com Supabase
            await syncWithSupabase();
        }
        
        async function syncWithSupabase() {
            // Sincroniza√ß√£o b√°sica - em produ√ß√£o usar√≠amos realtime
            const { data: patients } = await supabase
                .from('patients')
                .select('*')
                .eq('user_id', currentUser.id);
            
            if (patients) {
                localStorage.setItem('asm_patients', JSON.stringify(patients));
            }
        }
        
        // ============== DASHBOARD ==============
        async function loadDashboard() {
            const patients = JSON.parse(localStorage.getItem('asm_patients') || '[]');
            const appointments = JSON.parse(localStorage.getItem('asm_appointments') || '[]');
            const transactions = JSON.parse(localStorage.getItem('asm_transactions') || '[]');
            
            // Estat√≠sticas
            document.getElementById('statPatients').textContent = patients.length;
            
            const today = new Date().toISOString().split('T')[0];
            const todayApps = appointments.filter(a => a.date === today).length;
            document.getElementById('statToday').textContent = todayApps;
            
            const monthRevenue = transactions
                .filter(t => t.type === 'income' && t.date.startsWith(today.substring(0, 7)))
                .reduce((sum, t) => sum + parseFloat(t.value), 0);
            document.getElementById('statRevenue').textContent = 'R$' + monthRevenue.toFixed(2);
            
            // Pr√≥ximas consultas
            const upcoming = appointments
                .filter(a => new Date(a.date + 'T' + a.time) >= new Date())
                .sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time))
                .slice(0, 5);
            
            const container = document.getElementById('upcomingAppointments');
            if (upcoming.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Nenhuma consulta agendada</p>';
            } else {
                container.innerHTML = upcoming.map(app => {
                    const patient = patients.find(p => p.id === app.patient_id);
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee;">
                            <div>
                                <strong>${patient ? patient.name : 'Paciente'}</strong><br>
                                <small>${formatDate(app.date)} √†s ${app.time}</small>
                            </div>
                            <span class="badge badge-warning">${app.type}</span>
                        </div>
                    `;
                }).join('');
            }
        }
        
        // ============== PACIENTES ==============
        async function loadPatients() {
            const { data: patients } = await supabase
                .from('patients')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });
            
            const list = document.getElementById('patientsList');
            if (!patients || patients.length === 0) {
                list.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum paciente cadastrado</td></tr>';
                return;
            }
            
            list.innerHTML = patients.map(p => `
                <tr>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.phone || '-'}</td>
                    <td>${p.last_visit ? formatDate(p.last_visit) : 'Nunca'}</td>
                    <td><span class="badge badge-success">Ativo</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-sm btn-view" onclick="openEvolution('${p.id}')">üìã</button>
                            <button class="btn-sm btn-edit" onclick="editPatient('${p.id}')">‚úèÔ∏è</button>
                            <button class="btn-sm btn-delete" onclick="deletePatient('${p.id}')">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Atualizar select de pacientes
            updatePatientSelects(patients);
        }
        
        function updatePatientSelects(patients) {
            const options = patients.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            document.getElementById('appPatient').innerHTML = '<option value="">Selecione...</option>' + options;
            document.getElementById('docPatient').innerHTML = options;
        }
        
        document.getElementById('patientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const patientData = {
                user_id: currentUser.id,
                name: document.getElementById('patientName').value,
                birth_date: document.getElementById('patientBirth').value,
                cpf: document.getElementById('patientCpf').value,
                phone: document.getElementById('patientPhone').value,
                email: document.getElementById('patientEmail').value,
                address: document.getElementById('patientAddress').value,
                complaint: document.getElementById('patientComplaint').value,
                history: document.getElementById('patientHistory').value,
                created_at: new Date().toISOString()
            };
            
            const patientId = document.getElementById('patientId').value;
            
            if (patientId) {
                await supabase.from('patients').update(patientData).eq('id', patientId);
            } else {
                await supabase.from('patients').insert([patientData]);
            }
            
            closeModal('patientModal');
            loadPatients();
            showAlert('loginAlert', 'Paciente salvo com sucesso!', 'success');
        });
        
        function editPatient(id) {
            // Implementar edi√ß√£o
        }
        
        async function deletePatient(id) {
            if (!confirm('Tem certeza que deseja excluir este paciente?')) return;
            await supabase.from('patients').delete().eq('id', id);
            loadPatients();
        }
        
        function searchPatients() {
            const term = document.getElementById('searchPatient').value.toLowerCase();
            const rows = document.querySelectorAll('#patientsList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }
        
        // ============== AGENDA ==============
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Espa√ßos vazios
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += '<div></div>';
            }
            
            // Dias
            const appointments = JSON.parse(localStorage.getItem('asm_appointments') || '[]');
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasEvent = appointments.some(a => a.date === dateStr);
                
                const div = document.createElement('div');
                div.className = 'calendar-day' + (hasEvent ? ' has-event' : '');
                div.textContent = day;
                div.onclick = () => showDayAppointments(dateStr);
                grid.appendChild(div);
            }
        }
        
        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }
        
        function showDayAppointments(date) {
            // Implementar visualiza√ß√£o do dia
        }
        
        document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const appData = {
                user_id: currentUser.id,
                patient_id: document.getElementById('appPatient').value,
                date: document.getElementById('appDate').value,
                time: document.getElementById('appTime').value,
                type: document.getElementById('appType').value,
                notes: document.getElementById('appNotes').value,
                created_at: new Date().toISOString()
            };
            
            await supabase.from('appointments').insert([appData]);
            
            closeModal('appointmentModal');
            loadDashboard();
            alert('Agendamento salvo!');
        });
        
        // ============== FINANCEIRO ==============
        async function loadTransactions() {
            const { data: transactions } = await supabase
                .from('transactions')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });
            
            let income = 0, expense = 0;
            
            const list = document.getElementById('transactionsList');
            if (!transactions || transactions.length === 0) {
                list.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum lan√ßamento</td></tr>';
            } else {
                list.innerHTML = transactions.map(t => {
                    if (t.type === 'income') income += parseFloat(t.value);
                    else expense += parseFloat(t.value);
                    
                    return `
                        <tr>
                            <td>${formatDate(t.date)}</td>
                            <td>${t.description}</td>
                            <td><span class="badge ${t.type === 'income' ? 'badge-success' : 'badge-danger'}">${t.type === 'income' ? 'Entrada' : 'Sa√≠da'}</span></td>
                            <td>R$ ${parseFloat(t.value).toFixed(2)}</td>
                            <td>
                                <button class="btn-sm btn-delete" onclick="deleteTransaction('${t.id}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            document.getElementById('finIncome').textContent = 'R$' + income.toFixed(2);
            document.getElementById('finExpense').textContent = 'R$' + expense.toFixed(2);
            document.getElementById('finBalance').textContent = 'R$' + (income - expense).toFixed(2);
        }
        
        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const transData = {
                user_id: currentUser.id,
                type: document.getElementById('transType').value,
                value: document.getElementById('transValue').value,
                description: document.getElementById('transDesc').value,
                date: document.getElementById('transDate').value,
                category: document.getElementById('transCategory').value,
                created_at: new Date().toISOString()
            };
            
            await supabase.from('transactions').insert([transData]);
            
            closeModal('transactionModal');
            loadTransactions();
        });
        
        // ============== PRONTU√ÅRIO/EVOLU√á√ÉO ==============
        async function openEvolution(patientId) {
            currentPatient = patientId;
            document.getElementById('evoPatientId').value = patientId;
            
            const { data: patient } = await supabase
                .from('patients')
                .select('*')
                .eq('id', patientId)
                .single();
            
            document.getElementById('patientEvolutionInfo').innerHTML = `
                <strong>${patient.name}</strong><br>
                <small>CPF: ${patient.cpf || '-'} | Tel: ${patient.phone || '-'}</small>
            `;
            
            // Carregar evolu√ß√µes
            const { data: evolutions } = await supabase
                .from('evolutions')
                .select('*')
                .eq('patient_id', patientId)
                .order('created_at', { ascending: false });
            
            const timeline = document.getElementById('evolutionTimeline');
            if (!evolutions || evolutions.length === 0) {
                timeline.innerHTML = '<p style="text-align: center; color: #666;">Nenhuma evolu√ß√£o registrada</p>';
            } else {
                timeline.innerHTML = evolutions.map(evo => `
                    <div class="timeline-item">
                        <div class="timeline-date">${formatDateTime(evo.created_at)}</div>
                        <div class="timeline-content">${evo.evolution}</div>
                        ${evo.conduct ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;"><strong>Conduta:</strong> ${evo.conduct}</div>` : ''}
                    </div>
                `).join('');
            }
            
            openModal('evolutionModal');
        }
        
        document.getElementById('evolutionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const evoData = {
                user_id: currentUser.id,
                patient_id: document.getElementById('evoPatientId').value,
                evolution: document.getElementById('evoText').value,
                conduct: document.getElementById('evoConduct').value,
                created_at: document.getElementById('evoDate').value || new Date().toISOString()
            };
            
            await supabase.from('evolutions').insert([evoData]);
            
            // Atualizar √∫ltima visita do paciente
            await supabase
                .from('patients')
                .update({ last_visit: new Date().toISOString() })
                .eq('id', evoData.patient_id);
            
            alert('Evolu√ß√£o salva!');
            openEvolution(evoData.patient_id);
        });
        
        // ============== DOCUMENTOS ==============
        function openDocModal(type) {
            const titles = {
                atestado: 'Atestado M√©dico',
                receita: 'Receitu√°rio',
                declaracao: 'Declara√ß√£o de Comparecimento',
                encaminhamento: 'Encaminhamento'
            };
            
            document.getElementById('docModalTitle').textContent = 'üìÑ ' + titles[type];
            
            const fields = {
                atestado: `
                    <div class="form-group">
                        <label>Dias de afastamento</label>
                        <input type="number" id="docDias" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>CID (opcional)</label>
                        <input type="text" id="docCid" placeholder="CID-10">
                    </div>
                `,
                receita: `
                    <div class="form-group">
                        <label>Prescri√ß√£o</label>
                        <textarea id="docPrescricao" rows="6" placeholder="1. Medicamento X - 1 comprimido ao dia..."></textarea>
                    </div>
                `,
                declaracao: `
                    <div class="form-group">
                        <label>Data do comparecimento</label>
                        <input type="date" id="docData" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                `,
                encaminhamento: `
                    <div class="form-group">
                        <label>Especialidade/Especialista</label>
                        <input type="text" id="docEspecialidade" placeholder="Ex: Dr. Jo√£o - Cardiologista">
                    </div>
                    <div class="form-group">
                        <label>Motivo do encaminhamento</label>
                        <textarea id="docMotivo" placeholder="Descreva o motivo..."></textarea>
                    </div>
                `
            };
            
            document.getElementById('docSpecificFields').innerHTML = fields[type];
            document.getElementById('docForm').dataset.type = type;
            openModal('docModal');
        }
        
        function generateDocPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const type = document.getElementById('docForm').dataset.type;
            
            // Cabe√ßalho
            doc.setFillColor(26, 35, 126);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(24);
            doc.text('ASM FISIOTERAPIA', 105, 25, { align: 'center' });
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.text('Dra. Andresa Augusto - CREFITO 40.9314-F', 105, 35, { align: 'center' });
            
            // Conte√∫do
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            
            const patientId = document.getElementById('docPatient').value;
            const patient = JSON.parse(localStorage.getItem('asm_patients') || '[]').find(p => p.id === patientId);
            
            let y = 60;
            
            if (type === 'atestado') {
                doc.setFontSize(16);
                doc.text('ATESTADO M√âDICO', 105, y, { align: 'center' });
                y += 20;
                
                doc.setFontSize(12);
                const dias = document.getElementById('docDias').value;
                const cid = document.getElementById('docCid').value;
                
                doc.text(`Atesto que ${patient ? patient.name : 'o(a) paciente'} necessita de afastamento`, 20, y);
                y += 10;
                doc.text(`de suas atividades por ${dias} dia(s) para tratamento de sa√∫de.`, 20, y);
                
                if (cid) {
                    y += 10;
                    doc.text(`CID-10: ${cid}`, 20, y);
                }
            } else if (type === 'receita') {
                doc.setFontSize(16);
                doc.text('RECEITU√ÅRIO', 105, y, { align: 'center' });
                y += 20;
                
                doc.setFontSize(12);
                doc.text('Paciente: ' + (patient ? patient.name : ''), 20, y);
                y += 15;
                
                const prescricao = document.getElementById('docPrescricao').value;
                const lines = doc.splitTextToSize(prescricao, 170);
                doc.text(lines, 20, y);
            }
            
            // Rodap√©
            y = 250;
            doc.setFontSize(10);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, y);
            y += 10;
            doc.text('_________________________________', 105, y, { align: 'center' });
            y += 5;
            doc.text('Dra. Andresa Augusto', 105, y, { align: 'center' });
            y += 5;
            doc.text('CREFITO 40.9314-F', 105, y, { align: 'center' });
            
            doc.save(`documento_${type}_${new Date().getTime()}.pdf`);
            closeModal('docModal');
        }
        
        function generateEvolutionPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 35, 126);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(20);
            doc.text('RELAT√ìRIO DE EVOLU√á√ÉO CL√çNICA', 105, 25, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            
            let y = 60;
            const evoText = document.getElementById('evoText').value;
            const evoConduct = document.getElementById('evoConduct').value;
            
            doc.text('Evolu√ß√£o:', 20, y);
            y += 10;
            const lines = doc.splitTextToSize(evoText, 170);
            doc.text(lines, 20, y);
            y += lines.length * 7 + 10;
            
            if (evoConduct) {
                doc.text('Conduta:', 20, y);
                y += 10;
                const condLines = doc.splitTextToSize(evoConduct, 170);
                doc.text(condLines, 20, y);
            }
            
            doc.save('evolucao_clinica.pdf');
        }
        
        function sendWhatsApp() {
            const phone = currentPatient ? currentPatient.phone : '';
            if (!phone) {
                alert('Paciente n√£o tem telefone cadastrado!');
                return;
            }
            const message = 'Ol√°! Sou da ASM Fisioterapia. Gostaria de confirmar sua consulta.';
            window.open(`https://wa.me/55${phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`, '_blank');
        }
        
        // ============== RELAT√ìRIOS ==============
        function generateFinancialReport() {
            const start = document.getElementById('relDateStart').value;
            const end = document.getElementById('relDateEnd').value;
            
            const transactions = JSON.parse(localStorage.getItem('asm_transactions') || '[]')
                .filter(t => t.date >= start && t.date <= end);
            
            const income = transactions.filter(t => t.type === 'income').reduce((s, t) => s + parseFloat(t.value), 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + parseFloat(t.value), 0);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 35, 126);
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(18);
            doc.text('RELAT√ìRIO FINANCEIRO', 105, 20, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.text(`Per√≠odo: ${formatDate(start)} a ${formatDate(end)}`, 20, 50);
            
            doc.text(`Total Entradas: R$ ${income.toFixed(2)}`, 20, 70);
            doc.text(`Total Sa√≠das: R$ ${expense.toFixed(2)}`, 20, 80);
            doc.text(`Saldo: R$ ${(income - expense).toFixed(2)}`, 20, 90);
            
            doc.save('relatorio_financeiro.pdf');
            
            document.getElementById('financialReportResult').innerHTML = `
                <div class="alert alert-success" style="margin-top: 20px;">
                    ‚úÖ Relat√≥rio gerado com sucesso!<br>
                    Entradas: R$ ${income.toFixed(2)}<br>
                    Sa√≠das: R$ ${expense.toFixed(2)}<br>
                    <strong>Saldo: R$ ${(income - expense).toFixed(2)}</strong>
                </div>
            `;
        }
        
        function generatePatientsReport() {
            const patients = JSON.parse(localStorage.getItem('asm_patients') || '[]');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(26, 35, 126);
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(18);
            doc.text('RELAT√ìRIO DE PACIENTES', 105, 20, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            
            let y = 50;
            patients.forEach(p => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(`Nome: ${p.name}`, 20, y);
                y += 10;
                doc.text(`Telefone: ${p.phone || '-'}`, 20, y);
                y += 15;
            });
            
            doc.save('relatorio_pacientes.pdf');
            
            document.getElementById('patientsReportResult').innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ Relat√≥rio de ${patients.length} pacientes gerado!
                </div>
            `;
        }
        
        // ============== UTILIT√ÅRIOS ==============
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function showAlert(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.className = `alert alert-${type}`;
            el.textContent = message;
            setTimeout(() => el.textContent = '', 5000);
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }
        
        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('pt-BR');
        }
        
        // M√°scaras de input
        document.getElementById('regCpf')?.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, '');
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            e.target.value = v;
        });
        
        document.getElementById('patientCpf')?.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, '');
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            e.target.value = v;
        });
        
        document.getElementById('patientPhone')?.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, '');
            v = v.replace(/(\d{2})(\d)/, '($1) $2');
            v = v.replace(/(\d{5})(\d)/, '$1-$2');
            e.target.value = v;
        });
        
        // Inicializar
        window.onload = initSupabase;
    </script>
</body>
</html>
